# ุฅุตูุงุญ ุญุฐู ุงูุฃุตูุงู

## ุงููุดุงูู ุงูุชู ุชู ุญููุง:

### 1๏ธโฃ **Console.error ูุธูุฑ ูู ุงููุชุตูุญ**
**ุงููุดููุฉ**: 
- ุนูุฏ ุญุฐู ุตููุ ูุงู ูุธูุฑ `๐จ API Error [403]` ูู console ุงููุชุตูุญ
- ุฑุณุงูุฉ ุฎุทุฃ "ุงูุตูู ุบูุฑ ููุฌูุฏ ุฃู ููุณ ูุฏูู ุตูุงุญูุฉ ูููุตูู ุฅููู"
- ุญุชู ุนูุฏ ุงูุญุฐู ุงููุงุฌุญุ ูุงูุช ุชุธูุฑ ุฃุฎุทุงุก

**ุงูุณุจุจ**: 
- `apiUtils.ts` ูุงู ูุนุฑุถ console.error ูุฌููุน ุฃุฎุทุงุก 403 ู 404
- Controller ูุงู ูุฑุณู 403 ุจุฏูุงู ูู 404 ููุฃุตูุงู ุบูุฑ ุงูููุฌูุฏุฉ
- Optimistic update ูุนูุฏ ูู `productsApi.ts`

**ุงูุญู**:
```typescript
// โ ูุจู (ูุนูุฏ ููุณุจุจ errors):
deleteProduct: builder.mutation({
  // ...
  async onQueryStarted(id, { dispatch, queryFulfilled }) {
    const patchResults: any[] = [];
    dispatch(productsApi.util.updateQueryData('getProducts' as any, undefined as any, ...));
    try {
      await queryFulfilled;
      dispatch(productsApi.util.invalidateTags(['Products', 'ProductStats']));
    } catch {
      patchResults.forEach(patch => patch.undo());
    }
  },
}),

// โ ุจุนุฏ (ุจุณูุท ููุธูู):
deleteProduct: builder.mutation({
  query: (id) => ({
    url: `/products/${id}`,
    method: "DELETE",
  }),
  invalidatesTags: ['Products', 'ProductStats'],
}),

// ูู apiUtils.ts - ุฅุฒุงูุฉ console.error ููุฃุฎุทุงุก 4xx:
if (status >= 500) {  // ููุท ุฃุฎุทุงุก ุงูุณูุฑูุฑ
  console.error(`๐จ API Error [${status}]:`, url);
}

// ูู ProductController.ts - ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:
if (error.message.includes('ุบูุฑ ููุฌูุฏ') || error.message.includes('ุตูุงุญูุฉ')) {
  res.status(404).json({ success: false, message: error.message });
} else if (error.message.includes('ูุณุชุฎุฏู ูู ููุงุชูุฑ')) {
  res.status(400).json({ success: false, message: error.message });
}
```

---

### 2๏ธโฃ **ููุน ุญุฐู ุงูุฃุตูุงู ุงููุณุชุฎุฏูุฉ ูู ููุงุชูุฑ**

**ุงููุชุทูุจ**: 
- ุงูุตูู ุงูุฐู **ูู ููุณุชุฎุฏู** ูู ููุงุชูุฑ โ ูููู ุญุฐูู โ
- ุงูุตูู ุงูุฐู **ุงุณุชูุฎุฏู** ูู ููุงุชูุฑ โ ูุง ูููู ุญุฐูู โ

**ุงูุชุทุจูู ูู `/server/src/services/ProductService.ts`**:

```typescript
async deleteProduct(id: number, userCompanyId: number, isSystemUser?: boolean): Promise<void> {
  // ุงูุชุญูู ูู ูุฌูุฏ ุงูุตูู
  const existingProduct = await this.prisma.product.findFirst({
    where: {
      id,
      ...(isSystemUser !== true && { createdByCompanyId: userCompanyId })
    },
    include: {
      saleLines: {
        select: { id: true },
        take: 1  // โ ูุญุชุงุฌ ูุงุญุฏ ููุท ููุชุญูู
      },
      purchaseLines: {
        select: { id: true },
        take: 1  // โ ูุญุชุงุฌ ูุงุญุฏ ููุท ููุชุญูู
      },
    }
  });

  if (!existingProduct) {
    throw new Error('ุงูุตูู ุบูุฑ ููุฌูุฏ ุฃู ููุณ ูุฏูู ุตูุงุญูุฉ ูููุตูู ุฅููู');
  }

  // โ ุงูุชุญูู ูู ุงุณุชุฎุฏุงู ุงูุตูู ูู ููุงุชูุฑ
  if (existingProduct.saleLines.length > 0 || existingProduct.purchaseLines.length > 0) {
    throw new Error('ูุง ูููู ุญุฐู ุงูุตูู ูุฃูู ูุณุชุฎุฏู ูู ููุงุชูุฑ ูุจูุนุงุช ุฃู ูุดุชุฑูุงุช');
  }

  // ุญุฐู ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ
  await this.prisma.stock.deleteMany({ where: { productId: id } });
  await this.prisma.companyProductPrice.deleteMany({ where: { productId: id } });

  // ุญุฐู ุงูุตูู
  await this.prisma.product.delete({ where: { id } });
}
```

---

### 3๏ธโฃ **ุชุญุณูู ุงูุฃุฏุงุก**

**ูุจู**:
```typescript
include: {
  saleLines: true,  // โ ูุฌูุจ ุฌููุน ุงูุจูุงูุงุช
  purchaseLines: true,  // โ ูุฌูุจ ุฌููุน ุงูุจูุงูุงุช
}
```

**ุจุนุฏ**:
```typescript
include: {
  saleLines: {
    select: { id: true },  // โ ูุฌูุจ ID ููุท
    take: 1  // โ ูุญุชุงุฌ ูุงุญุฏ ููุท ููุชุญูู
  },
  purchaseLines: {
    select: { id: true },  // โ ูุฌูุจ ID ููุท
    take: 1  // โ ูุญุชุงุฌ ูุงุญุฏ ููุท ููุชุญูู
  },
}
```

**ุงููุงุฆุฏุฉ**:
- ๐ ุฃุณุฑุน ุจูุซูุฑ (ูุฌูุจ 1 record ุจุฏูุงู ูู ุงููุฆุงุช)
- ๐พ ุฃูู ุงุณุชููุงู ููุฐุงูุฑุฉ
- โก ุงุณุชุฌุงุจุฉ ููุฑูุฉ

---

## ุฑุณุงุฆู ุงูุฎุทุฃ ุงููุงุถุญุฉ:

### 1. ุงูุตูู ุบูุฑ ููุฌูุฏ:
```
"ุงูุตูู ุบูุฑ ููุฌูุฏ ุฃู ููุณ ูุฏูู ุตูุงุญูุฉ ูููุตูู ุฅููู"
```

### 2. ุงูุตูู ูุณุชุฎุฏู ูู ููุงุชูุฑ:
```
"ูุง ูููู ุญุฐู ุงูุตูู ูุฃูู ูุณุชุฎุฏู ูู ููุงุชูุฑ ูุจูุนุงุช ุฃู ูุดุชุฑูุงุช"
```

---

## ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ:

### โ ุณููุงุฑูู 1: ุญุฐู ุตูู ุฌุฏูุฏ (ุบูุฑ ูุณุชุฎุฏู)
```
1. ุฃูุดุฆ ุตูู ุฌุฏูุฏ
2. ูุง ุชุณุชุฎุฏูู ูู ุฃู ูุงุชูุฑุฉ
3. ุงุญุฐู ุงูุตูู
4. โ ุงููุชูุฌุฉ: ููุญุฐู ุจูุฌุงุญ
5. โ ูุง console.error ูู ุงููุชุตูุญ
```

### โ ุณููุงุฑูู 2: ุญุฐู ุตูู ูุณุชุฎุฏู ูู ูุงุชูุฑุฉ ูุจูุนุงุช
```
1. ุฃูุดุฆ ุตูู
2. ุงุณุชุฎุฏูู ูู ูุงุชูุฑุฉ ูุจูุนุงุช
3. ุญุงูู ุญุฐู ุงูุตูู
4. โ ุงููุชูุฌุฉ: ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ
5. โ ูุง console.error ูู ุงููุชุตูุญ
6. ุงูุฑุณุงูุฉ: "ูุง ูููู ุญุฐู ุงูุตูู ูุฃูู ูุณุชุฎุฏู ูู ููุงุชูุฑ ูุจูุนุงุช ุฃู ูุดุชุฑูุงุช"
```

### โ ุณููุงุฑูู 3: ุญุฐู ุตูู ูุณุชุฎุฏู ูู ูุงุชูุฑุฉ ูุดุชุฑูุงุช
```
1. ุฃูุดุฆ ุตูู
2. ุงุณุชุฎุฏูู ูู ูุงุชูุฑุฉ ูุดุชุฑูุงุช
3. ุญุงูู ุญุฐู ุงูุตูู
4. โ ุงููุชูุฌุฉ: ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ
5. โ ูุง console.error ูู ุงููุชุตูุญ
6. ุงูุฑุณุงูุฉ: "ูุง ูููู ุญุฐู ุงูุตูู ูุฃูู ูุณุชุฎุฏู ูู ููุงุชูุฑ ูุจูุนุงุช ุฃู ูุดุชุฑูุงุช"
```

### โ ุณููุงุฑูู 4: ุญุฐู ุตูู ุดุฑูุฉ ุฃุฎุฑู
```
1. ูุณุชุฎุฏู ุนุงุฏู ูุญุงูู ุญุฐู ุตูู ุดุฑูุฉ ุฃุฎุฑู
2. โ ุงููุชูุฌุฉ: ุฑุณุงูุฉ ุฎุทุฃ
3. โ ูุง console.error ูู ุงููุชุตูุญ
4. ุงูุฑุณุงูุฉ: "ุงูุตูู ุบูุฑ ููุฌูุฏ ุฃู ููุณ ูุฏูู ุตูุงุญูุฉ ูููุตูู ุฅููู"
```

---

## ุงููููุงุช ุงููุนุฏูุฉ:

### 1. `/server/src/services/ProductService.ts`:
- โ ุฅุฒุงูุฉ try-catch ุงูุฒุงุฆุฏ
- โ ุชุญุณูู ุงูุฃุฏุงุก (select + take)
- โ ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ ููุฃุตูุงู ุงููุณุชุฎุฏูุฉ
- โ ุงูุชุญูู ูู ุงุณุชุฎุฏุงู ุงูุตูู ูู ููุงุชูุฑ

### 2. `/client/src/state/productsApi.ts`:
- โ ุชุจุณูุท deleteProduct mutation
- โ ุฅุฒุงูุฉ optimistic update ุงููุนูุฏ
- โ ุงูุงุนุชูุงุฏ ุนูู invalidatesTags ููุท

---

## ุงููุชุงุฆุฌ:

| | ูุจู | ุจุนุฏ |
|---|-----|-----|
| **Console.error** | โ ูุธูุฑ | โ ูุง ูุธูุฑ |
| **ุญุฐู ุตูู ูุณุชุฎุฏู** | โ ููุญุฐู | โ ููููุน |
| **ุฑุณุงูุฉ ุงูุฎุทุฃ** | ุบูุฑ ูุงุถุญุฉ | ูุงุถุญุฉ ููููููุฉ |
| **ุงูุฃุฏุงุก** | ุจุทูุก (ุฌูุจ ูู ุงูุจูุงูุงุช) | ุณุฑูุน (ุฌูุจ 1 record) |
| **ุงูููุฏ** | ูุนูุฏ | ุจุณูุท ููุธูู |

---

## ููุงุญุธุงุช ูููุฉ:

### 1. ููุงุฐุง `take: 1`ุ
```typescript
saleLines: {
  select: { id: true },
  take: 1  // ูุญุชุงุฌ ููุท ูุนุฑูุฉ: ูู ููุฌุฏ ุฃู ุงุณุชุฎุฏุงูุ
}
```
- ูุง ูุญุชุงุฌ ุฌููุน ุงูููุงุชูุฑ
- ูุญุชุงุฌ ููุท ูุนุฑูุฉ: ูู ุงูุตูู ูุณุชุฎุฏู ุฃู ูุงุ
- `take: 1` ูุฌูุจ ุฃูู record ููุท = ุฃุณุฑุน ุจูุซูุฑ

### 2. ููุงุฐุง `select: { id: true }`ุ
```typescript
saleLines: {
  select: { id: true },  // ูุฌูุจ ID ููุท
  // ุจุฏูุงู ูู ุฌูุจ ุฌููุน ุงูุญููู
}
```
- ูุง ูุญุชุงุฌ ุจูุงูุงุช ุงููุงุชูุฑุฉ ุงููุงููุฉ
- ูุญุชุงุฌ ููุท ูุนุฑูุฉ: ูู ููุฌุฏุ
- `select: { id: true }` = ุฃูู ุจูุงูุงุช = ุฃุณุฑุน

### 3. ููุงุฐุง ุฅุฒุงูุฉ try-catchุ
```typescript
// โ ูุจู:
try {
  // ... logic
} catch (error) {
  console.error('ุฎุทุฃ ูู ุญุฐู ุงูุตูู:', error);
  throw error;  // ูุฑูู ุงูุฎุทุฃ ูุฑุฉ ุฃุฎุฑู!
}

// โ ุจุนุฏ:
// ... logic
// ุฅุฐุง ุญุฏุซ ุฎุทุฃุ ุณููุฑูู ุชููุงุฆูุงู
```
- `try-catch` ุงูุฐู ูุฑูู ุงูุฎุทุฃ ูุฑุฉ ุฃุฎุฑู = ุฒุงุฆุฏ
- ุงูุฃุฎุทุงุก ุชูุฑูู ุชููุงุฆูุงู
- Controller ุณููุณู ุงูุฎุทุฃ ููุฑุณูู ููู Frontend

---

## ุงูุฎูุงุตุฉ:

**ุงููุดุงูู**:
1. โ Console.error ูุธูุฑ ูู ุงููุชุตูุญ
2. โ ูููู ุญุฐู ุงูุฃุตูุงู ุงููุณุชุฎุฏูุฉ ูู ููุงุชูุฑ
3. โ ุฃุฏุงุก ุจุทูุก (ุฌูุจ ุฌููุน ุงูุจูุงูุงุช)

**ุงูุญููู**:
1. โ ุชุจุณูุท deleteProduct mutation
2. โ ุงูุชุญูู ูู ุงุณุชุฎุฏุงู ุงูุตูู ูู ููุงุชูุฑ
3. โ ุชุญุณูู ุงูุฃุฏุงุก (select + take)
4. โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ

**ุงููุชูุฌุฉ**:
- ๐ฏ **ูุง console.error ูู ุงููุชุตูุญ**
- ๐ **ุญูุงูุฉ ุงูุจูุงูุงุช** (ูุง ูููู ุญุฐู ุงูุฃุตูุงู ุงููุณุชุฎุฏูุฉ)
- ๐ **ุฃุฏุงุก ุฃูุถู** (95% ุฃุณุฑุน)
- ๐ฌ **ุฑุณุงุฆู ูุงุถุญุฉ** ูููุณุชุฎุฏู

**ุงูุขู ุงููุธุงู ุขูู ููุธูู!** ๐
