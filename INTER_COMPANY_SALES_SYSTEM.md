# ๐ข ูุธุงู ุงููุจูุนุงุช ุจูู ุงูุดุฑูุงุช (Inter-Company Sales)

## ๐ ูุธุฑุฉ ุนุงูุฉ:

ูุธุงู ูุณูุญ ููุดุฑูุงุช ุงูุชุงุจุนุฉ ุจุงูุจูุน ูู ุฃุตูุงู ุงูุดุฑูุฉ ุงูุฃู ูุน ุฅุถุงูุฉ ูุงูุด ุฑุจุญุ ุญูุซ:
1. **ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ** ุชุจูุน ููุนููู ุงูููุงุฆู ูู ุฃุตูุงู ุงูุดุฑูุฉ ุงูุฃู
2. **ุชููุดุฃ ูุงุชูุฑุชุงู ุชููุงุฆูุงู**:
   - ูุงุชูุฑุฉ ุจูุน ููุนููู ุงูููุงุฆู (ูู ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ)
   - ูุงุชูุฑุฉ ุดุฑุงุก ุขุฌูุฉ ูู ุงูุดุฑูุฉ ุงูุฃู (ููุดุฑูุฉ ุงูุชุงุจุนุฉ)
3. **ูุชู ุฎุตู ุงููุฎุฒูู** ูู ุงูุดุฑูุฉ ุงูุฃู ูุจุงุดุฑุฉ
4. **ุญุณุงุจ ูุงูุด ุงูุฑุจุญ** ุชููุงุฆูุงู

---

## ๐ฏ ุงูููููู:

### ูุซุงู ุนููู:
- **ุงูุดุฑูุฉ ุงูุฃู**: ุดุฑูุฉ ุงูุณูุฑุงููู ุงูุฑุฆูุณูุฉ
- **ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ**: ูุฑุน ุทุฑุงุจูุณ
- **ุงูุนููู ุงูููุงุฆู**: ูุญูุฏ ุฃุญูุฏ

#### ุงูุณููุงุฑูู:
1. ูุฑุน ุทุฑุงุจูุณ ูุจูุน 10 ุตูุงุฏูู ุจูุงุท ููุนููู ูุญูุฏ ุฃุญูุฏ
2. ุณุนุฑ ุงูุดุฑูุฉ ุงูุฃู: 50 ุฏ.ู ููุตูุฏูู
3. ุณุนุฑ ุงููุฑุน (ูุน ูุงูุด ุฑุจุญ): 60 ุฏ.ู ููุตูุฏูู

#### ุงููุชูุฌุฉ:
- **ูุงุชูุฑุฉ ููุนููู**: 10 ร 60 = 600 ุฏ.ู (ูู ูุฑุน ุทุฑุงุจูุณ)
- **ูุงุชูุฑุฉ ูู ุงูุดุฑูุฉ ุงูุฃู**: 10 ร 50 = 500 ุฏ.ู (ุขุฌูุฉ ูููุฑุน)
- **ูุงูุด ุงูุฑุจุญ**: 600 - 500 = 100 ุฏ.ู
- **ุงููุฎุฒูู**: ููุฎุตู 10 ุตูุงุฏูู ูู ูุฎุฒูู ุงูุดุฑูุฉ ุงูุฃู

---

## ๐ง ุงูุจููุฉ ุงูุชูููุฉ:

### 1. Backend (Server):

#### ุฃ. DTOs (`/server/src/dto/interCompanySaleDto.ts`):
```typescript
CreateInterCompanySaleDto:
  - customerId?: number
  - saleType: 'CASH' | 'CREDIT'
  - paymentMethod?: 'CASH' | 'BANK' | 'CARD'
  - lines: Array<{
      productId: number
      qty: number
      parentUnitPrice: number      // ุณุนุฑ ุงูุดุฑูุฉ ุงูุฃู
      branchUnitPrice: number      // ุณุนุฑ ุงููุฑุน (ูุน ูุงูุด ุงูุฑุจุญ)
      subTotal: number
    }>
```

#### ุจ. Service (`/server/src/services/InterCompanySaleService.ts`):

**ุงููุธุงุฆู ุงูุฑุฆูุณูุฉ**:
1. **createInterCompanySale()**: ุฅูุดุงุก ูุงุชูุฑุฉ ูุจูุนุงุช ุจูู ุงูุดุฑูุงุช
   - ุงูุชุญูู ูู ุฃู ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ ููุง ุดุฑูุฉ ุฃู
   - ุฅูุดุงุก ูุงุชูุฑุฉ ุจูุน ููุนููู ุงูููุงุฆู
   - ุฅูุดุงุก ูุงุชูุฑุฉ ุดุฑุงุก ุขุฌูุฉ ูู ุงูุดุฑูุฉ ุงูุฃู
   - ุฎุตู ุงููุฎุฒูู ูู ุงูุดุฑูุฉ ุงูุฃู
   - ุญุณุงุจ ูุงูุด ุงูุฑุจุญ

2. **getInterCompanySales()**: ุฌูุจ ุฌููุน ุงููุจูุนุงุช ุจูู ุงูุดุฑูุงุช
   - ููุชุฑุฉ ุญุณุจ ุงูุนูููุ ููุน ุงูุจูุนุ ุงูุชุงุฑูุฎ
   - ุชุฑุชูุจ ุญุณุจ ุงูุชุงุฑูุฎ
   - pagination

3. **getInterCompanySaleById()**: ุฌูุจ ุชูุงุตูู ูุงุชูุฑุฉ ูุญุฏุฏุฉ
   - ุชูุงุตูู ูุงุชูุฑุฉ ุงูุจูุน
   - ุชูุงุตูู ูุงุชูุฑุฉ ุงูุดุฑุงุก ุงููุฑุชุจุทุฉ
   - ุญุณุงุจ ูุงูุด ุงูุฑุจุญ

4. **getInterCompanySalesStats()**: ุฅุญุตุงุฆูุงุช ุงููุจูุนุงุช
   - ุฅุฌูุงูู ุงููุจูุนุงุช
   - ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช
   - ุฅุฌูุงูู ุงูุชูููุฉ
   - ุฅุฌูุงูู ุงูุฑุจุญ
   - ูุณุจุฉ ูุงูุด ุงูุฑุจุญ

#### ุฌ. Controller (`/server/src/controllers/InterCompanySaleController.ts`):
- ูุนุงูุฌุฉ ุงูุทูุจุงุช HTTP
- ุงูุชุญูู ูู ุงููุตุงุฏูุฉ
- ุงูุชุญูู ูู ุฃู ุงูุดุฑูุฉ ุชุงุจุนุฉ
- ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

#### ุฏ. Routes (`/server/src/routes/interCompanySaleRoutes.ts`):
```
POST   /api/inter-company-sales          - ุฅูุดุงุก ูุงุชูุฑุฉ
GET    /api/inter-company-sales          - ุฌูุจ ุฌููุน ุงูููุงุชูุฑ
GET    /api/inter-company-sales/stats    - ุงูุฅุญุตุงุฆูุงุช
GET    /api/inter-company-sales/:id      - ุชูุงุตูู ูุงุชูุฑุฉ
```

---

### 2. Frontend (Client):

#### ุฃ. API (`/client/src/state/interCompanySalesApi.ts`):
- **createInterCompanySale**: ุฅูุดุงุก ูุงุชูุฑุฉ ุฌุฏูุฏุฉ
- **getInterCompanySales**: ุฌูุจ ูุงุฆูุฉ ุงูููุงุชูุฑ
- **getInterCompanySaleById**: ุฌูุจ ุชูุงุตูู ูุงุชูุฑุฉ
- **getInterCompanySalesStats**: ุฌูุจ ุงูุฅุญุตุงุฆูุงุช

#### ุจ. Redux Integration (`/client/src/app/redux.tsx`):
- ุฅุถุงูุฉ interCompanySalesApi ุฅูู store
- ุฅุถุงูุฉ middleware
- ุฅุถุงูุฉ reducer

---

## ๐ ูุงุนุฏุฉ ุงูุจูุงูุงุช:

### ุงูุฌุฏุงูู ุงููุณุชุฎุฏูุฉ:

#### 1. Sale (ูุงุชูุฑุฉ ุงูุจูุน ููุนููู ุงูููุงุฆู):
```prisma
model Sale {
  id              Int
  companyId       Int           // ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ
  customerId      Int?
  invoiceNumber   String?
  saleType        SaleType      // CASH ุฃู CREDIT
  paymentMethod   PaymentMethod?
  total           Decimal
  paidAmount      Decimal
  remainingAmount Decimal
  isFullyPaid     Boolean
  lines           SaleLine[]
  payments        SalePayment[]
  createdAt       DateTime
}
```

#### 2. PurchaseFromParent (ูุงุชูุฑุฉ ุงูุดุฑุงุก ูู ุงูุดุฑูุฉ ุงูุฃู):
```prisma
model PurchaseFromParent {
  id              Int
  branchCompanyId Int           // ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ
  parentCompanyId Int           // ุงูุดุฑูุฉ ุงูุฃู
  invoiceNumber   String?
  total           Decimal
  isSettled       Boolean       // ุฏุงุฆูุงู false (ุขุฌูุฉ)
  lines           PurchaseFromParentLine[]
  receipts        PurchaseFromParentReceipt[]
  createdAt       DateTime
}
```

#### 3. Stock (ุงููุฎุฒูู):
```prisma
model Stock {
  id        Int
  companyId Int     // ุงูุดุฑูุฉ ุงูุฃู
  productId Int
  boxes     Decimal // ูุชู ุงูุฎุตู ูู ููุง
}
```

---

## ๐ ุณูุฑ ุงูุนูู (Workflow):

### 1. ุฅูุดุงุก ูุงุชูุฑุฉ ูุจูุนุงุช ุจูู ุงูุดุฑูุงุช:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ ุชุฎุชุงุฑ ุงูุฃุตูุงู ูู ุงูุดุฑูุฉ ุงูุฃู              โ
โ  - ุชุญุฏุฏ ุงููููุฉ                                              โ
โ  - ุชุถูู ูุงูุด ุฑุจุญ ุนูู ุณุนุฑ ุงูุดุฑูุฉ ุงูุฃู                      โ
โ  - ุชุญุฏุฏ ุงูุนููู ุงูููุงุฆู                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุงููุธุงู ูุชุญูู ูู:                                          โ
โ  โ ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ ููุง ุดุฑูุฉ ุฃู                             โ
โ  โ ุงููุฎุฒูู ูุชููุฑ ูู ุงูุดุฑูุฉ ุงูุฃู                           โ
โ  โ ุงูุจูุงูุงุช ุตุญูุญุฉ                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Transaction (ุนูููุฉ ูุงุญุฏุฉ):                                โ
โ  1. ุฅูุดุงุก ูุงุชูุฑุฉ ุจูุน ููุนููู (Sale)                        โ
โ  2. ุฅูุดุงุก ูุงุชูุฑุฉ ุดุฑุงุก ูู ุงูุดุฑูุฉ ุงูุฃู (PurchaseFromParent)โ
โ  3. ุฎุตู ุงููุฎุฒูู ูู ุงูุดุฑูุฉ ุงูุฃู (Stock)                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุงููุชูุฌุฉ:                                                   โ
โ  โ ูุงุชูุฑุฉ ุจูุน ููุนููู (ุจุณุนุฑ ุงููุฑุน)                        โ
โ  โ ูุงุชูุฑุฉ ุดุฑุงุก ุขุฌูุฉ ูู ุงูุดุฑูุฉ ุงูุฃู (ุจุณุนุฑ ุงูุฃู)           โ
โ  โ ูุฎุฒูู ุงูุดุฑูุฉ ุงูุฃู ูุฎุตูู                                โ
โ  โ ูุงูุด ุงูุฑุจุญ ูุญุณูุจ                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ฐ ุญุณุงุจ ุงูุฃุฑูุงู:

### ูุซุงู ุชูุตููู:

**ุงูุจูุงูุงุช**:
- ุงูุตูู: ุจูุงุท ุณูุฑุงููู
- ุงููููุฉ: 10 ุตูุงุฏูู
- ุณุนุฑ ุงูุดุฑูุฉ ุงูุฃู: 50 ุฏ.ู/ุตูุฏูู
- ุณุนุฑ ุงููุฑุน: 60 ุฏ.ู/ุตูุฏูู

**ุงูุญุณุงุจุงุช**:
```
ุฅุฌูุงูู ูุงุชูุฑุฉ ุงูุนููู (ุงูุฅูุฑุงุฏุงุช):
10 ร 60 = 600 ุฏ.ู

ุฅุฌูุงูู ูุงุชูุฑุฉ ุงูุดุฑูุฉ ุงูุฃู (ุงูุชูููุฉ):
10 ร 50 = 500 ุฏ.ู

ูุงูุด ุงูุฑุจุญ:
600 - 500 = 100 ุฏ.ู

ูุณุจุฉ ูุงูุด ุงูุฑุจุญ:
(100 / 600) ร 100 = 16.67%
```

---

## ๐ ุงูุฅุญุตุงุฆูุงุช ุงููุชููุฑุฉ:

1. **ุฅุฌูุงูู ุงููุจูุนุงุช**: ุนุฏุฏ ุงูููุงุชูุฑ
2. **ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช**: ูุฌููุน ููุงุชูุฑ ุงูุนููุงุก
3. **ุฅุฌูุงูู ุงูุชูููุฉ**: ูุฌููุน ููุงุชูุฑ ุงูุดุฑูุฉ ุงูุฃู
4. **ุฅุฌูุงูู ุงูุฑุจุญ**: ุงูุฅูุฑุงุฏุงุช - ุงูุชูููุฉ
5. **ูุณุจุฉ ูุงูุด ุงูุฑุจุญ**: (ุงูุฑุจุญ / ุงูุฅูุฑุงุฏุงุช) ร 100
6. **ุงููุจูุนุงุช ุงูููุฏูุฉ**: ุนุฏุฏ ุงูููุงุชูุฑ ุงูููุฏูุฉ
7. **ุงููุจูุนุงุช ุงูุขุฌูุฉ**: ุนุฏุฏ ุงูููุงุชูุฑ ุงูุขุฌูุฉ

---

## ๐ ุงูุฃูุงู ูุงูุตูุงุญูุงุช:

### 1. ุงูุชุญูู ูู ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ:
```typescript
const branchCompany = await prisma.company.findUnique({
  where: { id: branchCompanyId },
  include: { parent: true }
});

if (!branchCompany?.parentId) {
  throw new Error('ูุฐู ุงูุดุฑูุฉ ููุณุช ุดุฑูุฉ ุชุงุจุนุฉ');
}
```

### 2. ุงูุชุญูู ูู ุงููุฎุฒูู:
```typescript
if (Number(stock.boxes) < line.qty) {
  throw new Error('ุงููุฎุฒูู ุบูุฑ ูุงูู');
}
```

### 3. Transaction ููุญูุงุธ ุนูู ุชูุงูู ุงูุจูุงูุงุช:
```typescript
await prisma.$transaction(async (tx) => {
  // ุฌููุน ุงูุนูููุงุช ุชุชู ูู transaction ูุงุญุฏุฉ
  // ุฅุฐุง ูุดูุช ุฃู ุนูููุฉุ ูุชู ุงูุชุฑุงุฌุน ุนู ุงููู
});
```

---

## โ ุงูุญุงูุฉ ุงูุญุงููุฉ:

### ุชู ุฅูุฌุงุฒู:
- โ **Backend ูุงูู**: DTOs, Service, Controller, Routes
- โ **Frontend API**: RTK Query hooks
- โ **Redux Integration**: Store setup
- โ **ูุงุนุฏุฉ ุงูุจูุงูุงุช**: Schema ููุฌูุฏ ูุณุจูุงู
- โ **ุงูุฃูุงู**: ุงูุชุญูู ูู ุงูุตูุงุญูุงุช ูุงููุฎุฒูู
- โ **Transaction**: ุถูุงู ุชูุงูู ุงูุจูุงูุงุช

### ุงููุชุจูู:
- โณ **ุตูุญุฉ Frontend**: ูุงุฌูุฉ ุงููุณุชุฎุฏู ูุฅูุดุงุก ูุนุฑุถ ุงูููุงุชูุฑ
- โณ **ุงุฎุชุจุงุฑ ุงููุธุงู**: ุงูุชุฃูุฏ ูู ุนูู ุฌููุน ุงููุธุงุฆู
- โณ **ุงูุชูุซูู**: ุฏููู ุงููุณุชุฎุฏู

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ:

1. **ุฅูุดุงุก ุตูุญุฉ ุงููุจูุนุงุช ุจูู ุงูุดุฑูุงุช**:
   - ูููุฐุฌ ุฅูุดุงุก ูุงุชูุฑุฉ ุฌุฏูุฏุฉ
   - ุฌุฏูู ุนุฑุถ ุงูููุงุชูุฑ
   - ุจุทุงูุงุช ุงูุฅุญุตุงุฆูุงุช
   - ุชูุงุตูู ุงููุงุชูุฑุฉ

2. **ุงุฎุชุจุงุฑ ุงููุธุงู**:
   - ุฅูุดุงุก ูุงุชูุฑุฉ ุชุฌุฑูุจูุฉ
   - ุงูุชุญูู ูู ุฎุตู ุงููุฎุฒูู
   - ุงูุชุญูู ูู ุฅูุดุงุก ุงููุงุชูุฑุชูู
   - ุงูุชุญูู ูู ุญุณุงุจ ูุงูุด ุงูุฑุจุญ

3. **ุชุญุณููุงุช ูุญุชููุฉ**:
   - ุทุจุงุนุฉ ุงูููุงุชูุฑ
   - ุชูุงุฑูุฑ ููุตูุฉ
   - ุฑุณูู ุจูุงููุฉ ููุฃุฑุจุงุญ
   - ุชูุจููุงุช ุงููุฎุฒูู

---

## ๐ ููุงุญุธุงุช ูููุฉ:

1. **ุงูููุงุชูุฑ ูู ุงูุดุฑูุฉ ุงูุฃู ุฏุงุฆูุงู ุขุฌูุฉ**: ูุง ูุชู ุงูุณุฏุงุฏ ููุฑุงู
2. **ุงููุฎุฒูู ููุฎุตู ูู ุงูุดุฑูุฉ ุงูุฃู**: ููุณ ูู ุงูุดุฑูุฉ ุงูุชุงุจุนุฉ
3. **ูุงูุด ุงูุฑุจุญ ููุญุณุจ ุชููุงุฆูุงู**: ุงููุฑู ุจูู ุณุนุฑ ุงูุจูุน ูุงูุชูููุฉ
4. **Transaction ุชุถูู ุงูุชูุงูู**: ุฅูุง ุชูุฌุญ ุฌููุน ุงูุนูููุงุช ุฃู ุชูุดู ุฌููุนูุง

---

**ุงููุธุงู ุฌุงูุฒ ูููุฑุญูุฉ ุงูุชุงููุฉ: ุฅูุดุงุก ูุงุฌูุฉ ุงููุณุชุฎุฏู! ๐**
