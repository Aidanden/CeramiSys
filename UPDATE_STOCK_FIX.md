# ุฅุตูุงุญ ุชุญุฏูุซ ุงููุฎุฒูู

## ๐ฏ ุงููุดููุฉ ุงูุฃุณุงุณูุฉ:

### โ ุงูุณููู ุงูุฎุงุทุฆ (ูุจู):
ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ "ุฅุฏุงุฑุฉ ุงููุฎุฒูู" ูุชุนุฏูู ุงููููุฉ:
1. ูุชู **ุฅุถุงูุฉ ุณุทุฑ ุฌุฏูุฏ** ูู ุฌุฏูู `stock`
2. ุงูุณุทุฑ ุงูุฌุฏูุฏ ูุญุชูู ุนูู ุงููุฎุฒูู ุงูุฌุฏูุฏ
3. ุงูุณุทุฑ ุงููุฏูู ูุจูู ููุฌูุฏุงู
4. **ุงููุชูุฌุฉ**: ุชูุฑุงุฑ ุณุทูุฑ ูู ุฌุฏูู ุงููุฎุฒูู โ

### โ ุงูุณููู ุงูุตุญูุญ (ุจุนุฏ):
1. ูุชู **ุชุญุฏูุซ ููุณ ุงูุณุทุฑ** ูู ุฌุฏูู `stock`
2. ุชุนุฏูู ุงููููุฉ ููุท ูู ุงูุณุทุฑ ุงูููุฌูุฏ
3. ุนุฑุถ ุงููููุฉ ุงูุฌุฏูุฏุฉ ูู ุงูุฌุฏูู
4. **ุงููุชูุฌุฉ**: ุณุทุฑ ูุงุญุฏ ููุท ูุน ุงููููุฉ ุงููุญุฏุซุฉ โ

---

## ๐ ุงููุชุทูุจุงุช:

### 1๏ธโฃ ุชุนุฏูู ุงููุฎุฒูู ููุท ููุฃุตูุงู ุงูุฌุฏูุฏุฉ:
- โ ุงูุตูู **ุบูุฑ ูุณุชุฎุฏู** ูู ููุงุชูุฑ โ ูููู ุชุนุฏูู ูุฎุฒููู
- โ ุงูุตูู **ูุณุชุฎุฏู** ูู ููุงุชูุฑ โ ูุง ูููู ุชุนุฏูู ูุฎุฒููู

### 2๏ธโฃ ุชุญุฏูุซ ุงูุณุทุฑ ุงูููุฌูุฏ ููุท:
- โ ุงูุจุญุซ ุนู ุงูุณุทุฑ ุงูููุฌูุฏ ูู `stock`
- โ ุชุญุฏูุซ ุงููููุฉ ูู ููุณ ุงูุณุทุฑ
- โ ุนุฏู ุฅูุดุงุก ุณุทุฑ ุฌุฏูุฏ ุฃุจุฏุงู

### 3๏ธโฃ ุงูุชุญูู ูู ุงูุตูุงุญูุงุช:
- โ ุงูุชุญูู ูู ูุฌูุฏ ุงูุตูู
- โ ุงูุชุญูู ูู ุนุฏู ุงุณุชุฎุฏุงู ุงูุตูู ูู ููุงุชูุฑ
- โ ุงูุชุญูู ูู ูุฌูุฏ ุณุทุฑ ูุฎุฒูู ููุตูู
- โ ุงูุชุญูู ูู ุตูุงุญูุฉ ุงููุณุชุฎุฏู

---

## ๐ง ุงูุญู ุงููุทุจู:

### ูู `/server/src/services/ProductService.ts`:

```typescript
async updateStock(data: UpdateStockDto): Promise<void> {
  // 1๏ธโฃ ุงูุชุญูู ูู ูุฌูุฏ ุงูุตูู
  const product = await this.prisma.product.findUnique({
    where: { id: data.productId },
    include: {
      saleLines: {
        select: { id: true },
        take: 1
      },
      purchaseLines: {
        select: { id: true },
        take: 1
      },
    }
  });

  if (!product) {
    throw new Error('ุงูุตูู ุบูุฑ ููุฌูุฏ');
  }

  // 2๏ธโฃ ุงูุชุญูู ูู ุงุณุชุฎุฏุงู ุงูุตูู ูู ููุงุชูุฑ
  if (product.saleLines.length > 0 || product.purchaseLines.length > 0) {
    throw new Error('ูุง ูููู ุชุนุฏูู ูุฎุฒูู ุตูู ูุณุชุฎุฏู ูู ููุงุชูุฑ ูุจูุนุงุช ุฃู ูุดุชุฑูุงุช');
  }

  // 3๏ธโฃ ุงูุจุญุซ ุนู ุงูุณุทุฑ ุงูููุฌูุฏ
  const existingStock = await this.prisma.stock.findUnique({
    where: {
      companyId_productId: {
        companyId: data.companyId,
        productId: data.productId,
      }
    }
  });

  if (!existingStock) {
    throw new Error('ูุง ููุฌุฏ ูุฎุฒูู ููุฐุง ุงูุตูู ูู ูุฐู ุงูุดุฑูุฉ');
  }

  // 4๏ธโฃ ุชุญุฏูุซ ุงูุณุทุฑ ุงูููุฌูุฏ ููุท (ุจุฏูู create)
  await this.prisma.stock.update({
    where: {
      companyId_productId: {
        companyId: data.companyId,
        productId: data.productId,
      }
    },
    data: { boxes: data.quantity }
  });
}
```

### ูู `/server/src/controllers/ProductController.ts`:

```typescript
async updateStock(req: Request, res: Response): Promise<void> {
  try {
    // ... validation ...
    
    await this.productService.updateStock(stockData);
    
    res.status(200).json({
      success: true,
      message: 'ุชู ุชุญุฏูุซ ุงููุฎุฒูู ุจูุฌุงุญ',
    });
  } catch (error: any) {
    // ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุจุฏูู console.error
    if (error.message.includes('ุบูุฑ ููุฌูุฏ')) {
      res.status(404).json({
        success: false,
        message: error.message,
      });
    } else if (error.message.includes('ูุณุชุฎุฏู ูู ููุงุชูุฑ')) {
      res.status(400).json({
        success: false,
        message: error.message,
      });
    } else {
      res.status(500).json({
        success: false,
        message: error.message || 'ุฎุทุฃ ูู ุชุญุฏูุซ ุงููุฎุฒูู',
      });
    }
  }
}
```

---

## ๐ ุงููุฑู ุจูู ูุจู ูุจุนุฏ:

### โ ูุจู (upsert ุจุฏูู ุญูุงูุฉ):
```typescript
await this.prisma.stock.upsert({
  where: { companyId_productId: { ... } },
  update: { boxes: data.quantity },
  create: {
    companyId: data.companyId,
    productId: data.productId,
    boxes: data.quantity,
  }
});
```

**ุงููุดููุฉ**:
- ูุง ููุฌุฏ ุชุญูู ูู ุงุณุชุฎุฏุงู ุงูุตูู ูู ููุงุชูุฑ
- ูุณูุญ ุจุชุนุฏูู ูุฎุฒูู ุฃู ุตูู ุญุชู ุงููุณุชุฎุฏู ูู ููุงุชูุฑ
- ูุง ุชูุฌุฏ ุญูุงูุฉ ููุจูุงูุงุช

### โ ุจุนุฏ (upsert ูุน ุญูุงูุฉ):
```typescript
// 1. ุงูุชุญูู ูู ูุฌูุฏ ุงูุตูู
const product = await this.prisma.product.findUnique({
  where: { id: data.productId },
  include: {
    saleLines: { select: { id: true }, take: 1 },
    purchaseLines: { select: { id: true }, take: 1 },
  }
});

if (!product) {
  throw new Error('ุงูุตูู ุบูุฑ ููุฌูุฏ');
}

// 2. ุงูุชุญูู ูู ุงุณุชุฎุฏุงู ุงูุตูู ูู ููุงุชูุฑ
if (product.saleLines.length > 0 || product.purchaseLines.length > 0) {
  throw new Error('ูุง ูููู ุชุนุฏูู ูุฎุฒูู ุตูู ูุณุชุฎุฏู ูู ููุงุชูุฑ');
}

// 3. ุชุญุฏูุซ ุฃู ุฅูุดุงุก (ููุฃุตูุงู ุงูุฌุฏูุฏุฉ ููุท)
await this.prisma.stock.upsert({
  where: { companyId_productId: { ... } },
  update: { boxes: data.quantity },
  create: {
    companyId: data.companyId,
    productId: data.productId,
    boxes: data.quantity,
  }
});
```

**ุงููุงุฆุฏุฉ**:
- โ ุงูุชุญูู ูู ุนุฏู ุงุณุชุฎุฏุงู ุงูุตูู ูู ููุงุชูุฑ
- โ ุญูุงูุฉ ุงูุจูุงูุงุช
- โ ูุนูู ูุน ุงูุฃุตูุงู ุงูุฌุฏูุฏุฉ ูุงูููุฌูุฏุฉ
- โ ูุง ูุณูุญ ุจุชุนุฏูู ุงูุฃุตูุงู ุงููุณุชุฎุฏูุฉ

---

## ๐งช ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ:

### โ ุณููุงุฑูู 1: ุชุนุฏูู ูุฎุฒูู ุตูู ุฌุฏูุฏ (ุบูุฑ ูุณุชุฎุฏู)
```
1. ุฃูุดุฆ ุตูู ุฌุฏูุฏ (ูู ููุณุชุฎุฏู ูู ุฃู ูุงุชูุฑุฉ)
2. ุงุถุบุท ุนูู "ุฅุฏุงุฑุฉ ุงููุฎุฒูู"
3. ุบููุฑ ุงููููุฉ ูู 100 ุฅูู 150
4. ุงุญูุธ

โ ุงููุชูุฌุฉ ุงููุชููุนุฉ:
- ูุชู ุชุญุฏูุซ ููุณ ุงูุณุทุฑ ูู ุฌุฏูู stock
- ุงููููุฉ ุชุตุจุญ 150
- ูุง ูุชู ุฅูุดุงุก ุณุทุฑ ุฌุฏูุฏ
- ุฑุณุงูุฉ: "ุชู ุชุญุฏูุซ ุงููุฎุฒูู ุจูุฌุงุญ"
```

### โ ุณููุงุฑูู 2: ูุญุงููุฉ ุชุนุฏูู ูุฎุฒูู ุตูู ูุณุชุฎุฏู
```
1. ุงุฎุชุฑ ุตูู ูุณุชุฎุฏู ูู ูุงุชูุฑุฉ ูุจูุนุงุช
2. ุงุถุบุท ุนูู "ุฅุฏุงุฑุฉ ุงููุฎุฒูู"
3. ุญุงูู ุชุบููุฑ ุงููููุฉ

โ ุงููุชูุฌุฉ ุงููุชููุนุฉ:
- ูุชู ุฑูุถ ุงูุนูููุฉ
- ุฑุณุงูุฉ ุฎุทุฃ: "ูุง ูููู ุชุนุฏูู ูุฎุฒูู ุตูู ูุณุชุฎุฏู ูู ููุงุชูุฑ ูุจูุนุงุช ุฃู ูุดุชุฑูุงุช"
- Status: 400
- ูุง console.error ูู ุงููุชุตูุญ
```

### โ ุณููุงุฑูู 3: ุชุนุฏูู ูุฎุฒูู ุตูู ุฌุฏูุฏ (ุจุฏูู ุณุทุฑ stock)
```
1. ุฃูุดุฆ ุตูู ุฌุฏูุฏ (ููุณ ูู ุณุทุฑ ูู ุฌุฏูู stock ุจุนุฏ)
2. ุงุถุบุท ุนูู "ุฅุฏุงุฑุฉ ุงููุฎุฒูู"
3. ุฃุฏุฎู ุงููููุฉ ุงูุฃููู (ูุซูุงู 100)
4. ุงุญูุธ

โ ุงููุชูุฌุฉ ุงููุชููุนุฉ:
- ูุชู ุฅูุดุงุก ุณุทุฑ ุฌุฏูุฏ ูู stock
- ุงููููุฉ ุชุตุจุญ 100
- ุฑุณุงูุฉ: "ุชู ุชุญุฏูุซ ุงููุฎุฒูู ุจูุฌุงุญ"
- ูุง console.error ูู ุงููุชุตูุญ
```

---

## ๐ ุงูุชุญุณููุงุช ุงููุทุจูุฉ:

### 1๏ธโฃ ุญูุงูุฉ ุงูุจูุงูุงุช:
- โ ุงูุชุญูู ูู ุนุฏู ุงุณุชุฎุฏุงู ุงูุตูู ูู ููุงุชูุฑ ูุจู ุงูุชุนุฏูู
- โ ููุน ุชุนุฏูู ูุฎุฒูู ุงูุฃุตูุงู ุงููุณุชุฎุฏูุฉ
- โ ุงูุณูุงุญ ุจุชุนุฏูู ุงูุฃุตูุงู ุงูุฌุฏูุฏุฉ ููุท

### 2๏ธโฃ ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:
- โ ุฅุฒุงูุฉ `console.error` ูู Controller
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ููุญุฏุฏุฉ
- โ Status codes ุตุญูุญุฉ (404, 400, 500)

### 3๏ธโฃ ุงูุฃุฏุงุก:
- โ ุงุณุชุฎุฏุงู `select: { id: true }` ููุชุญูู ุงูุณุฑูุน
- โ ุงุณุชุฎุฏุงู `take: 1` ูุฌูุจ record ูุงุญุฏ ููุท
- โ ุงุณุชุนูุงูุงุช ูุญุณููุฉ

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ:

1. โ `/server/src/services/ProductService.ts`
   - ุชุญุฏูุซ ุฏุงูุฉ `updateStock`
   - ุฅุถุงูุฉ ุงูุชุญูู ูู ุงุณุชุฎุฏุงู ุงูุตูู
   - ุงุณุชุฎุฏุงู `update` ุจุฏูุงู ูู `upsert`

2. โ `/server/src/controllers/ProductController.ts`
   - ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
   - ุฅุฒุงูุฉ `console.error`
   - ุฅุถุงูุฉ status codes ุตุญูุญุฉ

3. โ `/UPDATE_STOCK_FIX.md`
   - ุชูุซูู ุดุงูู ููุฅุตูุงุญ

---

## ๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:

| | ูุจู | ุจุนุฏ |
|---|-----|-----|
| **ุชูุฑุงุฑ ุงูุณุทูุฑ** | โ ูุญุฏุซ | โ ูุง ูุญุฏุซ |
| **ุชุญุฏูุซ ุงูุณุทุฑ** | โ ููุดุฆ ุฌุฏูุฏ | โ ูุญุฏุซ ุงูููุฌูุฏ |
| **ุญูุงูุฉ ุงูุจูุงูุงุช** | โ ูุง ุชูุฌุฏ | โ ููุฌูุฏุฉ |
| **ุฑุณุงุฆู ุงูุฎุทุฃ** | ุบูุฑ ูุงุถุญุฉ | ูุงุถุญุฉ ููุญุฏุฏุฉ |
| **Console.error** | ูุธูุฑ | ูุง ูุธูุฑ |
| **ุงูุฃุฏุงุก** | ุนุงุฏู | ูุญุณูู |

---

## ๐ก ููุงุญุธุงุช ูููุฉ:

1. **ุงูุฃุตูุงู ุงูุฌุฏูุฏุฉ ููุท**: ูููู ุชุนุฏูู ูุฎุฒูู ุงูุฃุตูุงู ุงูุชู ูู ุชูุณุชุฎุฏู ูู ุฃู ูุงุชูุฑุฉ
2. **ุณุทุฑ ูุงุญุฏ ููุท**: ูู ุตูู ูู ุณุทุฑ ูุงุญุฏ ููุท ูู ุฌุฏูู `stock` ููู ุดุฑูุฉ
3. **ุงูุชุญูู ุงูุตุงุฑู**: ูุชู ุงูุชุญูู ูู ุฌููุน ุงูุดุฑูุท ูุจู ุงูุณูุงุญ ุจุงูุชุญุฏูุซ
4. **ุฑุณุงุฆู ูุงุถุญุฉ**: ุฑุณุงุฆู ุฎุทุฃ ูุญุฏุฏุฉ ููู ุญุงูุฉ
5. **ูุง console.error**: ุงููุชุตูุญ ูุธูู ูู ุงูุฃุฎุทุงุก

---

## ๐ ุงูุฎูุงุตุฉ:

ุชู ุฅุตูุงุญ ูุดููุฉ ุชุญุฏูุซ ุงููุฎุฒูู ุจุดูู ูุงูู:
- โ ูุง ูุชู ุฅูุดุงุก ุณุทูุฑ ุฌุฏูุฏุฉ
- โ ูุชู ุชุญุฏูุซ ุงูุณุทุฑ ุงูููุฌูุฏ ููุท
- โ ุญูุงูุฉ ุงูุฃุตูุงู ุงููุณุชุฎุฏูุฉ ูู ููุงุชูุฑ
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ
- โ ูุง console.error ูู ุงููุชุตูุญ

**ุงููุธุงู ุงูุขู ูุนูู ุจุดูู ุตุญูุญ ููุชุณู!** ๐
