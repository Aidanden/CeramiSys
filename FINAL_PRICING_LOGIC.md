# منطق التسعير النهائي - السعر للمتر والمجموع بالأمتار

## 🎯 المطلوب النهائي

### في فاتورة المبيعات:
1. **خانة السعر**: تعرض سعر المتر الواحد (مثل: 120.50 د.ل/م²)
2. **المجموع**: يحسب السعر × الكمية بالأمتار (وليس بالصناديق)

## 📊 مثال عملي

### صنف: بلاط سيراميك أبيض 60×60
- **السعر في قاعدة البيانات**: 120.50 د.ل/م²
- **عدد الأمتار في الصندوق**: 6 م²/صندوق

### في الفاتورة:
- **الكمية**: 5 صناديق
- **السعر المعروض**: 120.50 د.ل/م² ✅
- **إجمالي الأمتار**: 5 × 6 = 30 م²
- **المجموع**: 30 × 120.50 = 3,615 د.ل ✅

## 🛠️ التطبيق التقني

### 1. السعر عند إضافة المنتج:
```typescript
// السعر يُحفظ كما هو (سعر المتر المربع)
updateSaleLine(newIndex, 'unitPrice', Number(product.price.sellPrice));
```

### 2. حساب المجموع:
```typescript
const calculateLineTotal = (line: any) => {
  const product = productsData?.data?.products?.find(p => p.id === line.productId);
  if (!product) return line.qty * line.unitPrice;
  
  // إذا كانت الوحدة صندوق، اضرب في عدد الأمتار
  if (product.unit === 'صندوق' && product.unitsPerBox) {
    const totalMeters = line.qty * Number(product.unitsPerBox);
    return totalMeters * line.unitPrice;
  }
  
  // للوحدات الأخرى (كيس، قطعة، لتر)
  return line.qty * line.unitPrice;
};
```

### 3. عرض السعر مع الوحدة:
```typescript
<label>
  السعر ({selectedProduct?.unit === 'صندوق' ? 'د.ل/م²' : `د.ل/${selectedProduct?.unit || 'وحدة'}`})
</label>
```

## 📋 الحالات المختلفة

### أ. الأصناف بوحدة "صندوق":
```
الكمية: 5 صناديق
السعر المعروض: 120.50 د.ل/م²
إجمالي الأمتار: 5 × 6 = 30 م²
المجموع: 30 × 120.50 = 3,615 د.ل
```

### ب. الأصناف بوحدة "كيس":
```
الكمية: 10 أكياس
السعر المعروض: 25 د.ل/كيس
المجموع: 10 × 25 = 250 د.ل
```

### ج. الأصناف بوحدة "قطعة":
```
الكمية: 50 قطعة
السعر المعروض: 5 د.ل/قطعة
المجموع: 50 × 5 = 250 د.ل
```

### د. الأصناف بوحدة "لتر":
```
الكمية: 20 لتر
السعر المعروض: 15 د.ل/لتر
المجموع: 20 × 15 = 300 د.ل
```

## 🎨 واجهة المستخدم

### عرض الكمية الإجمالية:
- **للصناديق**: "الكمية الإجمالية بالمتر" → "30 متر"
- **للأكياس**: "إجمالي الأكياس" → "10 كيس"
- **للقطع**: "إجمالي القطع" → "50 قطعة"
- **للترات**: "إجمالي اللترات" → "20 لتر"

### عرض السعر:
- **للصناديق**: "السعر (د.ل/م²)"
- **للأكياس**: "السعر (د.ل/كيس)"
- **للقطع**: "السعر (د.ل/قطعة)"
- **للترات**: "السعر (د.ل/لتر)"

### عرض التفاصيل (للصناديق فقط):
```
📊 5 صندوق × 6 متر/صندوق = 30 متر
```

## 🔧 الملفات المعدلة

### 1. المبيعات العادية:
- `/client/src/app/sales/page.tsx`
  - إزالة الضرب عند إضافة المنتج
  - إضافة دالة `calculateLineTotal()`
  - تحديث عرض السعر مع الوحدة

### 2. فواتير الشركات المترابطة:
- `/client/src/app/inter-company-sales/page.tsx`
  - إزالة الضرب عند اختيار المنتج
  - تحديث حساب المجموع عند تغيير الكمية/السعر

## ✅ النتيجة النهائية

### للمستخدم:
- 📊 **السعر واضح**: يعرض سعر المتر المربع
- 🧮 **الحساب صحيح**: المجموع = الأمتار × سعر المتر
- 🎯 **سهولة الفهم**: وحدة السعر واضحة في كل مكان

### للنظام:
- 🔄 **منطق موحد**: نفس الطريقة لجميع أنواع الفواتير
- 📈 **دقة الحسابات**: لا أخطاء في الضرب أو القسمة
- 🛠️ **سهولة الصيانة**: كود واضح ومنظم

## 🧪 اختبار النظام

### اختبار 1: صنف بوحدة صندوق
1. أضف "بلاط سيراميك أبيض 60×60"
2. أدخل الكمية: 5 صناديق
3. **تحقق**: السعر = 120.50 د.ل/م²
4. **تحقق**: المجموع = 30 × 120.50 = 3,615 د.ل

### اختبار 2: صنف بوحدة أخرى
1. أضف "كيس إسمنت"
2. أدخل الكمية: 10 أكياس
3. **تحقق**: السعر = 25 د.ل/كيس
4. **تحقق**: المجموع = 10 × 25 = 250 د.ل

---

**تاريخ التطبيق**: أكتوبر 2025  
**الحالة**: مطبق ✅  
**المنطق**: السعر للمتر، المجموع بالأمتار
