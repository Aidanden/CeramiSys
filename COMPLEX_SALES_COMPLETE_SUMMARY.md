# ملخص شامل لنظام المبيعات المعقدة بين الشركات

## 🎯 نظرة عامة:

نظام المبيعات المعقدة يسمح بإنشاء عمليات بيع من **الشركة الأم** إلى **العميل النهائي** عبر **الشركة الفرعية**، مع إنشاء فاتورتين تلقائياً وخصم المخزون من الشركة الأم.

---

## 📋 المكونات الأساسية:

### 1. الفواتير المنشأة:
```
فاتورة 1: الشركة الأم → الشركة الفرعية (آجل)
فاتورة 2: الشركة الفرعية → العميل النهائي (نقدي/آجل)
```

### 2. الأطراف المشاركة:
- **الشركة الأم**: مصدر البضاعة (مثل: التقازي)
- **الشركة الفرعية**: الوسيط المستلم (مثل: الإمارات)
- **العميل النهائي**: المشتري الفعلي (مثل: محمد أحمد)

### 3. العميل الوهمي:
- يمثل الشركة الفرعية كعميل للشركة الأم
- يُنشأ تلقائياً عند إضافة شركة فرعية
- المعرف: `BRANCH-{companyId}`

---

## 🔧 التحديثات المطبقة:

### 1. إضافة اختيار الشركة الفرعية في UI:
**الملف**: `/client/src/app/complex-inter-company-sales/page.tsx`

**التغييرات**:
- ✅ إضافة state: `selectedBranchCompany`
- ✅ فلترة الشركات الفرعية: `isParent === false && parentId !== null`
- ✅ حقل اختيار في الواجهة: "الشركة الفرعية (المستلمة)"
- ✅ Validation: التحقق من اختيار الشركة الفرعية
- ✅ إرسال `branchCompanyId` في الطلب

**قبل**:
```typescript
branchCompanyId: currentCompanyId  // ❌ تلقائي
```

**بعد**:
```typescript
branchCompanyId: selectedBranchCompany  // ✅ من الاختيار
```

---

### 2. إصلاح منطق العميل في الفواتير:
**الملف**: `/server/src/services/ComplexInterCompanySaleService.ts`

**المشكلة**:
```typescript
// ❌ قبل: العميل النهائي في كلا الفاتورتين
customerId: data.customerId
```

**الحل**:
```typescript
// ✅ بعد: الشركة الفرعية كعميل في فاتورة الأم
customerId: branchAsCustomer.id  // عميل وهمي يمثل الفرع
```

**النتيجة**:
- فاتورة الأم: التقازي → الإمارات (كعميل)
- فاتورة الفرع: الإمارات → محمد أحمد (العميل الحقيقي)

---

### 3. إصلاح ظهور الفواتير في المبيعات الآجلة:
**الملف**: `/server/src/services/SalePaymentService.ts`

**المشكلة**:
```typescript
// ❌ قبل: فقط المبيعات التي الشركة بائع فيها
where: {
  saleType: 'CREDIT',
  companyId: userCompanyId
}
```

**الحل**:
```typescript
// ✅ بعد: المبيعات التي الشركة بائع أو عميل فيها
const branchAsCustomer = await this.prisma.customer.findFirst({
  where: { phone: `BRANCH-${userCompanyId}` }
});

where.OR = [
  { companyId: userCompanyId },  // بائع
  ...(branchAsCustomer ? [{ customerId: branchAsCustomer.id }] : [])  // عميل
];
```

**النتيجة**:
- مستخدم الإمارات يرى فاتورتين في المبيعات الآجلة:
  1. من التقازي → الإمارات (دين على الإمارات)
  2. من الإمارات → العميل (دين للإمارات)

---

### 4. إنشاء عميل وهمي تلقائياً:
**الملف**: `/server/src/services/CompanyService.ts`

**التحديث**:
```typescript
// بعد إنشاء الشركة الفرعية بنجاح
if (!data.isParent && result.id) {
  try {
    const dummyCustomer = await this.prisma.customer.create({
      data: {
        name: result.name,
        phone: `BRANCH-${result.id}`,
        note: `عميل وهمي يمثل الشركة الفرعية: ${result.name}`
      }
    });
    console.log('✅ Dummy customer created for branch company:', dummyCustomer);
  } catch (customerError) {
    console.error('⚠️ Failed to create dummy customer (non-critical):', customerError);
  }
}
```

**الفائدة**:
- العميل الوهمي يُنشأ مرة واحدة عند إضافة الشركة
- جاهز للاستخدام في المبيعات المعقدة فوراً
- لا حاجة للتحقق والإنشاء في كل عملية

---

## 📊 مثال كامل:

### السيناريو:
```
الشركة الأم: شركة التقازي (ID: 1)
الشركة الفرعية: شركة الإمارات (ID: 2)
العميل النهائي: محمد أحمد (ID: 5)
العميل الوهمي: شركة الإمارات (ID: 10, Phone: BRANCH-2)

المنتج: بلاط سيراميك
الكمية: 100 متر مربع
سعر الأم: 10 د.ل/م²
هامش الربح: 20%
سعر العميل: 12 د.ل/م²
```

### النتيجة:

#### 1. فاتورة الأم (آجل):
```
ID: 1001
Invoice: PR-1-1234567890
البائع: شركة التقازي (ID: 1)
العميل: شركة الإمارات (ID: 10) ← عميل وهمي
النوع: آجل (CREDIT)
المبلغ: 1000 د.ل (100 × 10)
المدفوع: 0 د.ل
المتبقي: 1000 د.ل
الحالة: غير مدفوع
```

#### 2. فاتورة الفرع (نقدي/آجل):
```
ID: 1002
Invoice: BR-2-1234567891
البائع: شركة الإمارات (ID: 2)
العميل: محمد أحمد (ID: 5) ← العميل الحقيقي
النوع: نقدي/آجل (حسب الاختيار)
المبلغ: 1200 د.ل (100 × 12)
المدفوع: 1200 د.ل (إذا نقدي) أو 0 (إذا آجل)
الربح: 200 د.ل
```

#### 3. المخزون:
```
قبل العملية:
- التقازي: 50 صندوق (300 م²)

بعد العملية:
- التقازي: 33.33 صندوق (200 م²)
- تم خصم: 16.67 صندوق (100 م²)
```

---

## 🖥️ الواجهة الأمامية:

### الحقول بالترتيب:
```
┌─────────────────────────────────────────────┐
│ 1. العميل * (العميل النهائي)              │
├─────────────────────────────────────────────┤
│ 2. الشركة الفرعية (المستلمة) *            │
├─────────────────────────────────────────────┤
│ 3. الشركة الأم (المصدر) *                 │
├─────────────────────────────────────────────┤
│ 4. هامش الربح (%)                          │
├─────────────────────────────────────────────┤
│ 5. نوع فاتورة العميل (نقدي/آجل)          │
├─────────────────────────────────────────────┤
│ 6. طريقة الدفع (كاش/حوالة/بطاقة)          │
├─────────────────────────────────────────────┤
│ 7. البنود (الأصناف والكميات)              │
└─────────────────────────────────────────────┘
```

---

## 🔍 شاشة المبيعات الآجلة:

### لمستخدم شركة الإمارات:

#### الفواتير المعروضة:
```
1. فاتورة من التقازي → الإمارات
   - رقم الفاتورة: PR-1-1234567890
   - البائع: شركة التقازي
   - العميل: شركة الإمارات
   - المبلغ: 1000 د.ل
   - المدفوع: 0 د.ل
   - المتبقي: 1000 د.ل
   - الحالة: غير مدفوع
   - النوع: دين على الإمارات

2. فاتورة من الإمارات → محمد أحمد
   - رقم الفاتورة: BR-2-1234567891
   - البائع: شركة الإمارات
   - العميل: محمد أحمد
   - المبلغ: 1200 د.ل
   - المدفوع: 0 د.ل (إذا آجل)
   - المتبقي: 1200 د.ل
   - الحالة: غير مدفوع
   - النوع: دين للإمارات
```

---

## ✅ الفوائد النهائية:

### 1. **مرونة كاملة**:
- اختيار أي شركة فرعية
- اختيار أي عميل
- تحديد هامش الربح

### 2. **تتبع دقيق**:
- فواتير منفصلة لكل مستوى
- عملاء وهميين واضحين
- ظهور في المبيعات الآجلة

### 3. **محاسبة صحيحة**:
- الشركة الأم تعرف ديون الفروع عليها
- الفرع يعرف ديونه للأم وديون العملاء له
- حسابات منفصلة ودقيقة

### 4. **خصم مخزون صحيح**:
- يتم الخصم من الشركة الأم فقط
- حساب صحيح للوحدات والصناديق
- لا تكرار في الخصم

---

## 📁 الملفات المحدثة:

### Frontend:
1. ✅ `/client/src/app/complex-inter-company-sales/page.tsx`
   - إضافة اختيار الشركة الفرعية
   - Validation محسن
   - UI محدث

### Backend:
1. ✅ `/server/src/services/ComplexInterCompanySaleService.ts`
   - إصلاح منطق العميل
   - إنشاء/الحصول على عميل وهمي

2. ✅ `/server/src/services/SalePaymentService.ts`
   - إصلاح عرض المبيعات الآجلة
   - إصلاح الإحصائيات

3. ✅ `/server/src/services/CompanyService.ts`
   - إنشاء عميل وهمي تلقائياً

### Documentation:
1. ✅ `COMPLEX_SALES_BRANCH_SELECTION.md`
2. ✅ `COMPLEX_SALES_CUSTOMER_FIX.md`
3. ✅ `CREDIT_SALES_VISIBILITY_FIX.md`
4. ✅ `AUTO_CREATE_DUMMY_CUSTOMER.md`
5. ✅ `COMPLEX_SALES_COMPLETE_SUMMARY.md` (هذا الملف)

---

## 🚀 النظام الآن جاهز بالكامل!

جميع المشاكل تم حلها:
- ✅ اختيار الشركة الفرعية من UI
- ✅ العميل الصحيح في كل فاتورة
- ✅ ظهور الفواتير في المبيعات الآجلة
- ✅ إنشاء عميل وهمي تلقائياً
- ✅ تتبع دقيق للديون
- ✅ محاسبة صحيحة

**النظام يعمل بشكل كامل ومنطقي!** 🎉
