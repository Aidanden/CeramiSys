# إضافة وحدات جديدة: كيس و لتر

## الوحدات المدعومة الآن:

| الوحدة | الاستخدام | طريقة الحساب | حقل unitsPerBox |
|--------|-----------|--------------|----------------|
| **صندوق** | للسيراميك والبلاط | يُحسب بالمتر المربع (unitsPerBox × عدد الصناديق) | ✅ يظهر |
| **قطعة** | للقطع الفردية | يُحسب بالقطع مباشرة (لا تحويل) | ❌ مخفي |
| **كيس** | للمواد المعبأة بالأكياس | يُحسب بالأكياس مباشرة (وحدة مستقلة) | ❌ مخفي |
| **لتر** | للسوائل والمواد السائلة | يُحسب باللترات مباشرة (وحدة مستقلة) | ❌ مخفي |

---

## التغييرات المطبقة:

### 1. صفحة الأصناف (`/client/src/app/products/page.tsx`):

#### أ. تعريف الأنواع (Types):
```typescript
// قبل ❌
const [createUnit, setCreateUnit] = useState<'صندوق' | 'قطعة'>('صندوق');
const [editUnit, setEditUnit] = useState<'صندوق' | 'قطعة'>('صندوق');

// بعد ✅
const [createUnit, setCreateUnit] = useState<'صندوق' | 'قطعة' | 'كيس' | 'لتر'>('صندوق');
const [editUnit, setEditUnit] = useState<'صندوق' | 'قطعة' | 'كيس' | 'لتر'>('صندوق');
```

#### ب. القائمة المنسدلة في مودال الإضافة:
```typescript
<select
  name="unit"
  value={createUnit}
  onChange={(e) => setCreateUnit(e.target.value as 'صندوق' | 'قطعة' | 'كيس' | 'لتر')}
>
  <option value="صندوق">صندوق</option>
  <option value="قطعة">قطعة</option>
  <option value="كيس">كيس</option>      {/* ✅ جديد */}
  <option value="لتر">لتر</option>      {/* ✅ جديد */}
</select>
```

#### ج. القائمة المنسدلة في مودال التعديل:
```typescript
<select
  name="unit"
  value={editUnit}
  onChange={(e) => setEditUnit(e.target.value as 'صندوق' | 'قطعة' | 'كيس' | 'لتر')}
>
  <option value="صندوق">صندوق</option>
  <option value="قطعة">قطعة</option>
  <option value="كيس">كيس</option>      {/* ✅ جديد */}
  <option value="لتر">لتر</option>      {/* ✅ جديد */}
</select>
```

#### د. إخفاء حقل unitsPerBox للوحدات غير الصندوق:
```typescript
// ✅ الحقل يظهر فقط للصندوق:
{createUnit === 'صندوق' && (
  <div>
    <label>عدد الوحدات في الصندوق (بالمتر المربع)</label>
    <input
      name="unitsPerBox"
      placeholder="مثال: 1.44 (1.44 متر مربع في الصندوق)"
    />
  </div>
)}

// النتيجة:
// - صندوق → يظهر الحقل ✅
// - قطعة → الحقل مخفي ❌
// - كيس → الحقل مخفي ❌
// - لتر → الحقل مخفي ❌
```

---

### 2. صفحة المبيعات (`/client/src/app/sales/page.tsx`):

#### عرض الكمية الإجمالية:
```typescript
<label>
  {
    selectedProduct?.unit === 'صندوق' 
      ? 'الكمية الإجمالية بالمتر'
      : selectedProduct?.unit === 'قطعة'
        ? 'إجمالي القطع'
        : selectedProduct?.unit === 'كيس'
          ? 'إجمالي الأكياس'      // ✅ جديد
          : selectedProduct?.unit === 'لتر'
            ? 'إجمالي اللترات'     // ✅ جديد
            : 'الكمية الإجمالية'
  }
</label>
```

#### حساب الكمية:
```typescript
{line.qty > 0 ? (
  selectedProduct?.unit === 'صندوق' && selectedProduct?.unitsPerBox
    ? `${formatArabicArea(line.qty * Number(selectedProduct.unitsPerBox))} متر`
    : `${formatArabicArea(line.qty)} ${selectedProduct?.unit || 'وحدة'}`
) : '0'}
```

**الشرح**:
- **صندوق**: يُحسب `line.qty × unitsPerBox` ويُعرض بالمتر
- **قطعة / كيس / لتر**: يُعرض `line.qty` مباشرة مع اسم الوحدة

---

## أمثلة الاستخدام:

### مثال 1: صنف بوحدة "صندوق" (السيراميك):
```
الصنف: بلاط سيراميك أبيض
الوحدة: صندوق
عدد الوحدات في الصندوق: 1.44 متر

في الفاتورة:
- الكمية: 10 صناديق
- الإجمالي: 10 × 1.44 = 14.4 متر ✅
```

### مثال 2: صنف بوحدة "قطعة":
```
الصنف: باب خشبي
الوحدة: قطعة
عدد القطع في الصندوق: 1

في الفاتورة:
- الكمية: 5 قطع
- الإجمالي: 5 قطعة ✅ (لا تحويل)
```

### مثال 3: صنف بوحدة "كيس" (جديد):
```
الصنف: إسمنت
الوحدة: كيس
unitsPerBox: لا يوجد (الحقل مخفي)

في الفاتورة:
- الكمية: 100 كيس
- الإجمالي: 100 كيس ✅ (لا تحويل، وحدة مستقلة)
```

### مثال 4: صنف بوحدة "لتر" (جديد):
```
الصنف: دهان أبيض
الوحدة: لتر
unitsPerBox: لا يوجد (الحقل مخفي)

في الفاتورة:
- الكمية: 50 لتر
- الإجمالي: 50 لتر ✅ (لا تحويل، وحدة مستقلة)
```

---

## منطق الحساب:

### في الفواتير:
```typescript
// للصندوق فقط:
if (unit === 'صندوق' && unitsPerBox) {
  totalUnits = qty × unitsPerBox;  // بالمتر المربع
  display = `${totalUnits} متر`;
}

// لباقي الوحدات (قطعة، كيس، لتر):
else {
  totalUnits = qty;  // مباشرة
  display = `${qty} ${unit}`;
}
```

### في المخزون:
```typescript
// جميع الوحدات تُخزن بالصناديق:
stock.boxes = عدد الصناديق

// عند البيع:
stock.boxes -= qty;  // qty = عدد الصناديق دائماً
```

---

## قاعدة البيانات:

### Schema (Prisma):
```prisma
model Product {
  id           Int      @id @default(autoincrement())
  sku          String   @unique
  name         String
  unit         String?  // ✅ String مرن (يقبل أي وحدة)
  unitsPerBox  Float?   // عدد الوحدات في الصندوق
  // ...
}
```

**ملاحظة**: 
- حقل `unit` من نوع `String` (ليس enum)
- هذا يسمح بإضافة وحدات جديدة بسهولة بدون migration
- Frontend يتحكم في الوحدات المتاحة

---

## الفوائد:

### 1. مرونة:
- ✅ إضافة وحدات جديدة بسهولة
- ✅ لا حاجة لـ database migration
- ✅ Frontend يتحكم في الخيارات

### 2. وضوح:
- ✅ كل وحدة لها تسمية واضحة
- ✅ Labels ديناميكية حسب الوحدة
- ✅ عرض مناسب في الفواتير

### 3. بساطة:
- ✅ "كيس" و "لتر" يُعاملان مثل "قطعة"
- ✅ لا حسابات معقدة
- ✅ منطق موحد

---

## إضافة وحدات جديدة مستقبلاً:

إذا أردت إضافة وحدة جديدة (مثل "كرتون" أو "طن"):

### 1. في `/client/src/app/products/page.tsx`:
```typescript
// أضف الوحدة للـ type:
const [createUnit, setCreateUnit] = useState<'صندوق' | 'قطعة' | 'كيس' | 'لتر' | 'كرتون'>('صندوق');

// أضف option في القائمة المنسدلة:
<option value="كرتون">كرتون</option>
```

### 2. في `/client/src/app/sales/page.tsx`:
```typescript
// أضف حالة في عرض الكمية:
: selectedProduct?.unit === 'كرتون'
  ? 'إجمالي الكراتين'
  : 'الكمية الإجمالية'
```

### 3. قرر طريقة الحساب:
- **إذا كانت مثل "صندوق"**: أضف منطق حساب بالمتر
- **إذا كانت مثل "قطعة"**: لا تفعل شيء (تُحسب مباشرة)

---

## الملفات المعدلة:

1. ✅ `/client/src/app/products/page.tsx`:
   - السطر 60-61: تعريف الأنواع
   - السطر 74: مزامنة الوحدة في التعديل
   - السطر 1047-1053: القائمة المنسدلة (مودال الإضافة)
   - السطر 1192-1198: القائمة المنسدلة (مودال التعديل)

2. ✅ `/client/src/app/sales/page.tsx`:
   - السطر 1420-1429: عرض الكمية الإجمالية

3. ✅ `/NEW_UNITS_FEATURE.md`: هذا الملف (التوثيق)

---

## الاختبار:

### 1. إضافة صنف بوحدة "كيس":
```
1. اضغط "صنف جديد"
2. املأ البيانات:
   - الاسم: إسمنت
   - الكود: CEM-001
   - الوحدة: كيس
   - ❌ حقل "عدد الوحدات في الصندوق" مخفي (لا يظهر)
   - السعر: 25 د.ل
3. احفظ
4. ✅ النتيجة: الصنف يُنشأ بوحدة "كيس" (وحدة مستقلة)
```

### 2. إضافة صنف بوحدة "لتر":
```
1. اضغط "صنف جديد"
2. املأ البيانات:
   - الاسم: دهان أبيض
   - الكود: PAINT-001
   - الوحدة: لتر
   - ❌ حقل "عدد الوحدات في الصندوق" مخفي (لا يظهر)
   - السعر: 15 د.ل
3. احفظ
4. ✅ النتيجة: الصنف يُنشأ بوحدة "لتر" (وحدة مستقلة)
```

### 3. إنشاء فاتورة بصنف "كيس":
```
1. افتح شاشة المبيعات
2. أضف الصنف "إسمنت" (كيس)
3. أدخل الكمية: 100 كيس
4. ✅ النتيجة: 
   - Label: "الكمية (كيس)"
   - الإجمالي: "100 كيس"
   - لا تحويل للمتر
```

### 4. إنشاء فاتورة بصنف "لتر":
```
1. افتح شاشة المبيعات
2. أضف الصنف "دهان أبيض" (لتر)
3. أدخل الكمية: 50 لتر
4. ✅ النتيجة:
   - Label: "الكمية (لتر)"
   - الإجمالي: "50 لتر"
   - لا تحويل للمتر
```

---

## الخلاصة:

**الوحدات المدعومة**:
- ✅ صندوق (يُحسب بالمتر، حقل unitsPerBox يظهر)
- ✅ قطعة (مباشرة، وحدة مستقلة)
- ✅ كيس (مباشرة، وحدة مستقلة - جديد)
- ✅ لتر (مباشرة، وحدة مستقلة - جديد)

**المعاملة**:
- **صندوق**: وحدة خاصة (يُحسب × unitsPerBox بالمتر المربع)
- **قطعة، كيس، لتر**: وحدات مستقلة تماماً (بدون تحويل، بدون صناديق)

**النتيجة**:
- 🎯 **مرونة في إضافة وحدات جديدة**
- 📊 **عرض واضح ومناسب لكل وحدة**
- 💪 **منطق بسيط وسهل الصيانة**
- ✅ **جاهز للاستخدام الفوري**

**الآن يمكنك إضافة أصناف بوحدات: صندوق، قطعة، كيس، أو لتر!** 🎉
