# نظام المبيعات المعقدة بين الشركات

## نظرة عامة

تم تطوير نظام متقدم للمبيعات المعقدة بين الشركات يدعم السيناريو التالي:

### السيناريو المدعوم:
1. **شركة التقازي** (الشركة الأم) لديها أصناف ومخزون
2. **شركة الإمارات** (الفرع) تريد بيع أصناف التقازي للعميل
3. **العميل** يشتري من شركة الإمارات
4. **العمليات المطلوبة**:
   - خصم المخزون من شركة التقازي
   - إنشاء فاتورة بيع آجل من التقازي للإمارات
   - إنشاء فاتورة بيع للعميل من الإمارات (بهامش ربح)

## المكونات المطورة

### 1. Backend Services

#### `ComplexInterCompanySaleService.ts`
- **الوظيفة**: خدمة العمليات المعقدة بين الشركات
- **الطرق الرئيسية**:
  - `createComplexInterCompanySale()`: إنشاء عملية بيع معقدة
  - `settleParentSale()`: تسوية فاتورة الشراء من الشركة الأم
  - `getComplexInterCompanyStats()`: الحصول على الإحصائيات

#### `ComplexInterCompanySaleController.ts`
- **الوظيفة**: تحكم في طلبات API
- **الطرق**:
  - `createComplexInterCompanySale()`: إنشاء عملية بيع
  - `settleParentSale()`: تسوية فاتورة
  - `getComplexInterCompanyStats()`: جلب الإحصائيات

#### `complexInterCompanySaleRoutes.ts`
- **المسارات**:
  - `POST /api/complex-inter-company-sales`: إنشاء عملية بيع
  - `POST /api/complex-inter-company-sales/:parentSaleId/settle`: تسوية فاتورة
  - `GET /api/complex-inter-company-sales/stats`: جلب الإحصائيات

### 2. Frontend Components

#### `complexInterCompanySalesApi.ts`
- **الوظيفة**: RTK Query API للعمليات المعقدة
- **الـ Hooks**:
  - `useCreateComplexInterCompanySaleMutation`
  - `useSettleParentSaleMutation`
  - `useGetComplexInterCompanyStatsQuery`

#### `complex-inter-company-sales/page.tsx`
- **الوظيفة**: صفحة إدارة المبيعات المعقدة
- **المميزات**:
  - إنشاء عمليات بيع معقدة
  - حساب هامش الربح تلقائياً
  - عرض الإحصائيات
  - واجهة مستخدم متقدمة

## كيفية عمل النظام

### 1. إنشاء عملية بيع معقدة

```typescript
// البيانات المطلوبة
const saleData = {
  customerId: 1,           // العميل
  branchCompanyId: 2,      // شركة الإمارات
  parentCompanyId: 1,      // شركة التقازي
  lines: [
    {
      productId: 1,
      qty: 10,
      parentUnitPrice: 100,    // سعر التقازي
      branchUnitPrice: 120,    // سعر الإمارات (مع هامش ربح)
      subTotal: 1200
    }
  ],
  profitMargin: 20          // 20% هامش ربح
};
```

### 2. العمليات التي يتم تنفيذها

#### أ) التحقق من الصلاحيات
- التحقق من أن المستخدم مصرح له بالعمل
- التحقق من وجود الشركات والعميل
- التحقق من توفر المخزون

#### ب) خصم المخزون من الشركة الأم
```sql
UPDATE Stock 
SET boxes = boxes - qty 
WHERE companyId = parentCompanyId AND productId = productId
```

#### ج) إنشاء فاتورة بيع آجل من التقازي للإمارات
```typescript
const parentSale = {
  companyId: parentCompanyId,
  customerId: customerId,
  saleType: 'CREDIT',
  total: parentTotal,
  remainingAmount: parentTotal,
  isFullyPaid: false
};
```

#### د) إنشاء فاتورة بيع للعميل من الإمارات
```typescript
const customerSale = {
  companyId: branchCompanyId,
  customerId: customerId,
  saleType: 'CASH',
  total: branchTotal,
  paidAmount: branchTotal,
  remainingAmount: 0,
  isFullyPaid: true
};
```

#### هـ) إنشاء سجل شراء من الشركة الأم
```typescript
const purchaseFromParent = {
  branchCompanyId: branchCompanyId,
  parentCompanyId: parentCompanyId,
  total: parentTotal,
  isSettled: false
};
```

### 3. تسوية فاتورة الشراء من الشركة الأم

```typescript
// تسوية جزئية أو كاملة
const settlement = {
  parentSaleId: 123,
  amount: 500,
  paymentMethod: 'CASH'
};
```

## المميزات المتقدمة

### 1. حساب هامش الربح التلقائي
- يتم حساب سعر الإمارات تلقائياً بناءً على سعر التقازي + هامش الربح
- يمكن تعديل هامش الربح لكل عملية

### 2. إدارة المخزون الذكية
- التحقق من توفر المخزون قبل إنشاء العملية
- خصم المخزون تلقائياً من الشركة الأم
- تتبع التغييرات في المخزون

### 3. التقارير والإحصائيات
- إحصائيات مبيعات العملاء
- إحصائيات مشتريات من الشركة الأم
- إحصائيات مبيعات الشركة الأم
- تتبع المبالغ المتبقية

### 4. الأمان والصلاحيات
- التحقق من صلاحيات المستخدم
- التحقق من صحة البيانات
- معاملات قاعدة البيانات الآمنة

## واجهة المستخدم

### 1. الصفحة الرئيسية
- عرض الإحصائيات في بطاقات
- زر إنشاء عملية بيع جديدة
- تصميم متجاوب وحديث

### 2. نموذج إنشاء العملية
- اختيار العميل
- اختيار الشركة الأم
- تحديد هامش الربح
- إضافة بنود الفاتورة
- حساب الإجماليات تلقائياً

### 3. إدارة البنود
- إضافة/حذف البنود
- اختيار المنتجات
- تحديد الكميات والأسعار
- حساب الأسعار تلقائياً

## التكامل مع النظام الحالي

### 1. قاعدة البيانات
- يستخدم النماذج الموجودة (Sale, Stock, Product, Customer)
- لا يتطلب تغييرات في قاعدة البيانات
- متوافق مع النظام الحالي

### 2. APIs
- يستخدم نفس نظام المصادقة
- متوافق مع RTK Query
- يستخدم نفس نظام الأخطاء

### 3. الواجهة
- متوافق مع نظام التصميم الحالي
- يستخدم نفس المكونات
- متوافق مع نظام التنقل

## الاختبار

### 1. اختبار الوحدة
- اختبار الخدمات
- اختبار الـ Controllers
- اختبار الـ APIs

### 2. اختبار التكامل
- اختبار العمليات الكاملة
- اختبار قاعدة البيانات
- اختبار الواجهة

### 3. اختبار الأداء
- اختبار العمليات المعقدة
- اختبار قاعدة البيانات
- اختبار الذاكرة

## الصيانة والتطوير

### 1. إضافة مميزات جديدة
- يمكن إضافة مميزات جديدة بسهولة
- النظام قابل للتوسع
- وثائق شاملة

### 2. إصلاح الأخطاء
- نظام تسجيل الأخطاء
- رسائل خطأ واضحة
- سهولة التتبع

### 3. التحسينات
- تحسين الأداء
- تحسين الواجهة
- إضافة مميزات جديدة

## الخلاصة

تم تطوير نظام متقدم ومتكامل للمبيعات المعقدة بين الشركات يدعم:

✅ **السيناريو المطلوب**: بيع أصناف من شركة التقازي للعميل عبر شركة الإمارات
✅ **إدارة المخزون**: خصم المخزون من الشركة الأم تلقائياً
✅ **الفواتير**: إنشاء فواتير بيع آجل ونقدي
✅ **هامش الربح**: حساب تلقائي لهامش الربح
✅ **التقارير**: إحصائيات شاملة ومفصلة
✅ **الأمان**: نظام صلاحيات متقدم
✅ **الواجهة**: تصميم حديث ومتجاوب
✅ **التكامل**: متوافق مع النظام الحالي

النظام جاهز للاستخدام ويمكن توسيعه وإضافة مميزات جديدة حسب الحاجة.


