# إصلاح حساب الأسعار في فواتير المبيعات

## المشكلة

بعد تحويل الأسعار من "سعر الصندوق" إلى "سعر المتر المربع"، كانت فواتير المبيعات تستخدم سعر المتر مباشرة بدلاً من حساب سعر الصندوق الكامل.

### مثال على المشكلة:
```
الصنف: سيراميك أبيض
السعر في قاعدة البيانات: 150 د.ل/م² (بعد التحويل)
عدد الأمتار في الصندوق: 1.44 م²
سعر الصندوق المتوقع: 150 × 1.44 = 216 د.ل

❌ المشكلة: الفاتورة كانت تعرض 150 د.ل (سعر المتر)
✅ الحل: الفاتورة تعرض الآن 216 د.ل (سعر الصندوق)
```

## الحل المطبق

### 1. منطق حساب السعر الجديد

```typescript
// حساب السعر: إذا كانت الوحدة صندوق، اضرب في عدد الأمتار
const unitPrice = product.unit === 'صندوق' && product.unitsPerBox 
  ? Number(product.price.sellPrice) * Number(product.unitsPerBox)
  : Number(product.price.sellPrice);
```

### 2. الحالات المختلفة

#### أ. الأصناف بوحدة "صندوق":
- **السعر المحفوظ**: للمتر المربع (مثال: 150 د.ل/م²)
- **السعر في الفاتورة**: للصندوق الكامل (150 × 1.44 = 216 د.ل/صندوق)
- **الحساب**: `sellPrice × unitsPerBox`

#### ب. الأصناف بوحدات أخرى (قطعة، كيس، لتر):
- **السعر المحفوظ**: للوحدة (مثال: 25 د.ل/كيس)
- **السعر في الفاتورة**: نفس السعر (25 د.ل/كيس)
- **الحساب**: `sellPrice` مباشرة (لا تحويل)

## الملفات المعدلة

### 1. صفحة المبيعات العادية
**الملف**: `/client/src/app/sales/page.tsx`

**المواضع المعدلة**:
- **السطر 241-246**: عند إضافة منتج عبر QR Code
- **السطر 489-494**: عند البحث بكود المنتج
- **السطر 1354-1359**: عند اختيار المنتج من القائمة المنسدلة

### 2. فواتير الشركات المترابطة
**الملف**: `/client/src/app/inter-company-sales/page.tsx`

**المواضع المعدلة**:
- **السطر 151-158**: عند اختيار المنتج وحساب السعر الأساسي والهامش

## أمثلة عملية

### مثال 1: صنف بوحدة صندوق
```
الصنف: بلاط سيراميك أبيض 60×60
الوحدة: صندوق
عدد الأمتار في الصندوق: 6 م²
السعر المحفوظ: 20.08 د.ل/م²

في الفاتورة:
الكمية: 5 صناديق
السعر للصندوق: 20.08 × 6 = 120.48 د.ل/صندوق
المجموع: 5 × 120.48 = 602.40 د.ل ✅
```

### مثال 2: صنف بوحدة كيس
```
الصنف: كيس قورت أبيض إيطالي
الوحدة: كيس
السعر المحفوظ: 25 د.ل/كيس

في الفاتورة:
الكمية: 10 أكياس
السعر للكيس: 25 د.ل/كيس (لا تحويل)
المجموع: 10 × 25 = 250 د.ل ✅
```

### مثال 3: صنف بوحدة لتر
```
الصنف: لتر زيت تنظيف
الوحدة: لتر
السعر المحفوظ: 15 د.ل/لتر

في الفاتورة:
الكمية: 20 لتر
السعر للتر: 15 د.ل/لتر (لا تحويل)
المجموع: 20 × 15 = 300 د.ل ✅
```

## التحقق من الإصلاح

### 1. اختبار الأصناف بوحدة صندوق:
1. افتح فاتورة مبيعات جديدة
2. اختر صنف وحدته "صندوق"
3. تحقق أن السعر = `سعر المتر × عدد الأمتار في الصندوق`

### 2. اختبار الأصناف بوحدات أخرى:
1. اختر صنف وحدته "كيس" أو "قطعة" أو "لتر"
2. تحقق أن السعر = السعر المحفوظ مباشرة

### 3. اختبار طرق الإضافة المختلفة:
- ✅ إضافة عبر QR Code
- ✅ إضافة عبر البحث بالكود
- ✅ إضافة عبر القائمة المنسدلة

## النتائج المتوقعة

### قبل الإصلاح ❌:
```
صنف بوحدة صندوق:
- السعر في الفاتورة: 150 د.ل (خطأ - سعر المتر)
- المجموع: 5 × 150 = 750 د.ل (خطأ)
```

### بعد الإصلاح ✅:
```
صنف بوحدة صندوق:
- السعر في الفاتورة: 216 د.ل (صحيح - سعر الصندوق)
- المجموع: 5 × 216 = 1080 د.ل (صحيح)
```

## ملاحظات مهمة

### 1. التوافق مع التحديث السابق:
- هذا الإصلاح يعمل مع نظام الأسعار الجديد (سعر المتر)
- يحافظ على التوافق مع الوحدات المختلفة (صندوق، كيس، قطعة، لتر)

### 2. عدم التأثير على البيانات المحفوظة:
- لا يغير أي بيانات في قاعدة البيانات
- يؤثر فقط على حساب الأسعار في واجهة المستخدم

### 3. الشمولية:
- يغطي جميع طرق إضافة المنتجات للفاتورة
- يعمل مع جميع أنواع الفواتير (عادية، شركات مترابطة)

---

**تاريخ الإصلاح**: أكتوبر 2025  
**الحالة**: مطبق ✅  
**التأثير**: جميع فواتير المبيعات تحسب الأسعار بشكل صحيح
