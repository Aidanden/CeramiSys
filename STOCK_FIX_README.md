# ๐ ุฅุตูุงุญ ูุดููุฉ ุชุญุฏูุซ ุงููุฎุฒูู ุนูุฏ ุงูุจูุน

## ๐ ุงููุดููุฉ

ุนูุฏ ุจูุน ุตูู ูู ุงููุฎุฒููุ ูุงู ุงููุฎุฒูู ูุง ูุชู ุฎุตูู ุจุดูู ุตุญูุญ:

### ูุซุงู ุนูู ุงููุดููุฉ:
- **ุงููุฎุฒูู ุงูุฃููู**: 50 ุตูุฏูู ูู ุตูู CER-001
- **ุงููููุฉ ุงููุจุงุนุฉ**: 30 ุตูุฏูู (ูุฏุฎููุง ุงููุณุชุฎุฏู ูู Frontend)
- **ุงููุฎุฒูู ุงููุชููุน**: 20 ุตูุฏูู (50 - 30 = 20) โ
- **ุงููุฎุฒูู ุงููุนูู ูุจู ุงูุฅุตูุงุญ**: 45 ุตูุฏูู โ **ุฎุทุฃ!**

### ุงูุณุจุจ ุงูุฌุฐุฑู:

**Frontend ูุฑุณู ุนุฏุฏ ุงูุตูุงุฏูู ูุจุงุดุฑุฉุ ููู Backend ูุงู ูุญุณุจูุง ุฎุทุฃู!**

- Frontend: ุงููุณุชุฎุฏู ูุฏุฎู "30 ุตูุฏูู" โ `line.qty = 30`
- Backend ุงููุฏูู: ููุชุฑุถ ุฃู 30 = ุฃูุชุงุฑุ ููุญุณุจ `Math.ceil(30 / 6) = 5` ุตูุงุฏูู โ
- ุงููุชูุฌุฉ: ูุฎุตู 5 ุตูุงุฏูู ุจุฏูุงู ูู 30!

---

## ๐ ุงูุชูุงุตูู ุงูุชูููุฉ

### ุงูููุฏ ุงููุฏูู (ุงูุฎุงุทุฆ):

```typescript
// ูู SalesService.ts - ุงูููุฏ ุงููุฏูู (ุงูุฎุงุทุฆ)
// ุชุญุฏูุซ ุงููุฎุฒูู
for (const line of data.lines) {
  const product = products.find(p => p.id === line.productId);
  if (!product) continue;
  
  // โ ุฎุทุฃ: ูุญุณุจ ุงูุตูุงุฏูู ูู ุงูุฃูุชุงุฑุ ููู Frontend ูุฑุณู ุตูุงุฏูู!
  let boxesToDecrement = line.qty;
  
  if (product.unit === 'ุตูุฏูู' && product.unitsPerBox && Number(product.unitsPerBox) > 0) {
    const requestedMeters = line.qty; // โ ุฎุทุฃ: line.qty ููุณุช ุฃูุชุงุฑ!
    const unitsPerBox = Number(product.unitsPerBox);
    boxesToDecrement = Math.ceil(requestedMeters / unitsPerBox); // โ ุญุณุงุจ ุฎุงุทุฆ!
  }
  
  await this.prisma.stock.update({
    data: { boxes: { decrement: boxesToDecrement } }
  });
}
```

### ุงููุดููุฉ:
- ุงููุณุชุฎุฏู ูุฏุฎู **30 ุตูุฏูู** ูู Frontend
- `line.qty = 30` (ุนุฏุฏ ุงูุตูุงุฏููุ ููุณ ุงูุฃูุชุงุฑ!)
- ุงูููุฏ ุงููุฏูู ููุชุฑุถ ุฃููุง ุฃูุชุงุฑ: `Math.ceil(30 / 6) = 5` ุตูุงุฏูู โ
- ุงููุชูุฌุฉ: ูุฎุตู **5 ุตูุงุฏูู** ุจุฏูุงู ูู **30 ุตูุฏูู**!

---

## โ ุงูุญู ุงููุทุจู

**ุงูุญู ุงูุจุณูุท: ุฅุฒุงูุฉ ุงูุญุณุงุจ ุงูุฎุงุทุฆ!**

Frontend ูุฑุณู ุนุฏุฏ ุงูุตูุงุฏูู ูุจุงุดุฑุฉุ ููุง ุญุงุฌุฉ ูุฃู ุญุณุงุจ ุฅุถุงูู.

### 1. ูู `SalesService.ts`:

```typescript
// ุชุญุฏูุซ ุงููุฎุฒูู
// ููุงุญุธุฉ: line.qty ูู Frontend ููุซู ุนุฏุฏ ุงูุตูุงุฏูู ูุจุงุดุฑุฉ ูุฌููุน ุงูุฃุตูุงู
for (const line of data.lines) {
  const product = products.find(p => p.id === line.productId);
  if (!product) continue;
  
  const boxesToDecrement = Number(line.qty); // โ ุจุณูุท ููุจุงุดุฑ!
  
  // Debug logging
  if (process.env.NODE_ENV !== 'production') {
    console.log('๐ฆ Stock Update:', {
      productName: product.name,
      productUnit: product.unit,
      qtyFromFrontend: line.qty,
      boxesToDecrement
    });
  }
  
  await this.prisma.stock.update({
    where: {
      companyId_productId: {
        companyId: userCompanyId,
        productId: line.productId
      }
    },
    data: {
      boxes: { decrement: boxesToDecrement } // โ ุตุญูุญ!
    }
  });
}
```

### 2. ูู `deleteSale` (ุฅุฑุฌุงุน ุงููุฎุฒูู ุนูุฏ ุงูุญุฐู):

```typescript
// ุฅุฑุฌุงุน ุงููุฎุฒูู
for (const line of existingSale.lines) {
  const boxesToIncrement = Number(line.qty); // โ ูุฑุฌุน ููุณ ุงููููุฉ
  
  await this.prisma.stock.update({
    where: {
      companyId_productId: {
        companyId: existingSale.companyId,
        productId: line.productId
      }
    },
    data: { boxes: { increment: boxesToIncrement } }
  });
}
```

### 3. ูู `ProvisionalSalesService.ts`:

ููุณ ุงูุฅุตูุงุญ ูู ุฏุงูุฉ `convertToSale`.

---

## ๐ ูุซุงู ุนูู ุงูุญุณุงุจ ุงูุตุญูุญ

### ุงูุณููุงุฑูู:
- **ุงูุตูู**: ุจูุงุท ุณูุฑุงููู CER-001
- **ุงููุญุฏุฉ**: ุตูุฏูู
- **ุงููุญุฏุงุช ูู ุงูุตูุฏูู**: 6 ูุชุฑ ูุฑุจุน
- **ุงููุฎุฒูู ุงูุญุงูู**: 50 ุตูุฏูู
- **ุงููุณุชุฎุฏู ูุฏุฎู**: 30 ุตูุฏูู

### ุงูุญุณุงุจ (ุจุนุฏ ุงูุฅุตูุงุญ):
```javascript
// Frontend
ุงููุณุชุฎุฏู ูุฏุฎู: 30 ุตูุฏูู
line.qty = 30

// Backend
boxesToDecrement = Number(line.qty) = 30 ุตูุฏูู โ
```

### ุงููุชูุฌุฉ:
- **ุงููุฎุฒูู ุจุนุฏ ุงูุจูุน**: 50 - 30 = **20 ุตูุฏูู** โ
- **ุงูุฃูุชุงุฑ ุงููุจุงุนุฉ**: 30 ร 6 = **180 ูุชุฑ ูุฑุจุน** โ

---

## ๐ฏ ููู ูุนูู ุงููุธุงู ุงูุขู

### ูู Frontend:
```typescript
// ุงููุณุชุฎุฏู ูุฏุฎู ุนุฏุฏ ุงูุตูุงุฏูู ูู ุญูู "ุนุฏุฏ ุงูุตูุงุฏูู"
const qty = 30; // 30 ุตูุฏูู

// ูุชู ุนุฑุถ ุงูุฃูุชุงุฑ ุชููุงุฆูุงู ูููุนูููุงุช ููุท
const totalMeters = qty * unitsPerBox; // 30 ร 6 = 180 ูุชุฑ

// ูุชู ุฅุฑุณุงู ุนุฏุฏ ุงูุตูุงุฏูู ุฅูู Backend
line.qty = 30; // โ ุตูุงุฏูู
```

### ูู Backend:
```typescript
// ูุง ุญุงุฌุฉ ูุฃู ุญุณุงุจ - ูุณุชุฎุฏู ุงููููุฉ ูุจุงุดุฑุฉ
const boxesToDecrement = Number(line.qty); // 30 ุตูุฏูู โ

// ุฎุตู ูู ุงููุฎุฒูู
await stock.update({
  data: { boxes: { decrement: 30 } }
});
```

### ุงููุชูุฌุฉ:
- โ **ุจุณูุท ููุจุงุดุฑ**
- โ **ูุง ุญุณุงุจุงุช ูุนูุฏุฉ**
- โ **ุงููุฎุฒูู ุฏููู 100%**

---

## ๐ง ุงููููุงุช ุงููุนุฏูุฉ

1. **`/server/src/services/SalesService.ts`**
   - ุงูุณุทูุฑ 184-224: ุฅุตูุงุญ ููุทู ุชุญุฏูุซ ุงููุฎุฒูู

2. **`/server/src/services/ProvisionalSalesService.ts`**
   - ุงูุณุทูุฑ 448-502: ุฅุตูุงุญ ููุทู ุชุญุฏูุซ ุงููุฎุฒูู ูู `convertToSale`

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ูุจู ุงูุฅุตูุงุญ:
```
ุงููุฎุฒูู: 50 ุตูุฏูู
ุงูุจูุน: 30 ูุชุฑ (5 ุตูุงุฏูู)
ุงููุชูุฌุฉ: 30 ุตูุฏูู โ (ุฎุตู 20 ุตูุฏูู ุจุฏูุงู ูู 5)
```

### ุจุนุฏ ุงูุฅุตูุงุญ:
```
ุงููุฎุฒูู: 50 ุตูุฏูู
ุงูุจูุน: 30 ูุชุฑ (5 ุตูุงุฏูู)
ุงููุชูุฌุฉ: 45 ุตูุฏูู โ (ุฎุตู 5 ุตูุงุฏูู)
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **Frontend ูุชุญูู**: ุงููุณุชุฎุฏู ูุฏุฎู ุนุฏุฏ ุงูุตูุงุฏููุ ูFrontend ูุนุฑุถ ุงูุฃูุชุงุฑ ูููุนูููุงุช ููุท.

2. **Backend ุจุณูุท**: ูุง ุญุงุฌุฉ ูุฃู ุญุณุงุจุงุช - ูุณุชุฎุฏู `line.qty` ูุจุงุดุฑุฉ.

3. **Debug Logging**: ุชู ุฅุถุงูุฉ console logs ููุตูุฉ ูู ูุถุน ุงูุชุทููุฑ ูุชุณููู ุชุชุจุน ุงูุนูููุงุช.

4. **ุงูุชูุงูู**: ุงูุฅุตูุงุญ ูุนูู ูุน ุฌููุน ุฃููุงุน ุงููุญุฏุงุช (ุตูุฏููุ ูุทุนุฉุ ูุฑุชููุฉุ ุฅูุฎ).

5. **ุงูููุงุชูุฑ ุงููุจุฏุฆูุฉ**: ุชู ุชุทุจูู ููุณ ุงูุฅุตูุงุญ ุนูู ุฏุงูุฉ `convertToSale`.

6. **ุงูุญุฐู**: ุนูุฏ ุญุฐู ูุงุชูุฑุฉุ ูุชู ุฅุฑุฌุงุน ููุณ ุนุฏุฏ ุงูุตูุงุฏูู ุงููุจุงุนุฉ ุฅูู ุงููุฎุฒูู.

---

## โ ุงูุชุญูู ูู ุงูุฅุตูุงุญ

ููุชุญูู ูู ุฃู ุงูุฅุตูุงุญ ูุนูู ุจุดูู ุตุญูุญ:

1. **ุงูุชุญ ุงููุฎุฒูู** ูุชุญูู ูู ุงููููุฉ ุงูุญุงููุฉ ููุตูู
2. **ุฃูุดุฆ ูุงุชูุฑุฉ ูุจูุนุงุช** ุจุจูุน ูููุฉ ูุนููุฉ
3. **ุชุญูู ูู ุงููุฎุฒูู** ูุฑุฉ ุฃุฎุฑู
4. **ุงุญุณุจ ุงููุฑู** ูุชุฃูุฏ ูู ุฃูู ูุทุงุจู ุนุฏุฏ ุงูุตูุงุฏูู ุงููุชููุน

### ูุซุงู:
```
1. ุงููุฎุฒูู ูุจู ุงูุจูุน: 50 ุตูุฏูู
2. ุงูุจูุน: 30 ูุชุฑ (ูู ุตูุฏูู = 6 ูุชุฑ)
3. ุงูุตูุงุฏูู ุงููุชููุนุฉ: Math.ceil(30/6) = 5 ุตูุงุฏูู
4. ุงููุฎุฒูู ุจุนุฏ ุงูุจูุน: 50 - 5 = 45 ุตูุฏูู โ
```

---

## ๐ ุงูุชุงุฑูุฎ

- **ุชุงุฑูุฎ ุงูุชุดุงู ุงููุดููุฉ**: 21 ุฃูุชูุจุฑ 2025
- **ุชุงุฑูุฎ ุงูุฅุตูุงุญ ุงูุฃูู** (ุฎุงุทุฆ): 21 ุฃูุชูุจุฑ 2025 - 3:04 PM
- **ุชุงุฑูุฎ ุงูุฅุตูุงุญ ุงูุตุญูุญ**: 21 ุฃูุชูุจุฑ 2025 - 3:15 PM
- **ุงูุฅุตุฏุงุฑ**: v1.1.0 (ุงูุฅุตูุงุญ ุงูุตุญูุญ)

---

## ๐จโ๐ป ุงููุทูุฑ

ุชู ุฅุตูุงุญ ุงููุดููุฉ ุจูุงุณุทุฉ Cascade AI Assistant
