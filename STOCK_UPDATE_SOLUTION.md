# ุญู ูุดููุฉ ุชุญุฏูุซ ุงููุฎุฒูู - ุงูุญู ุงูููุงุฆู ุงูุตุญูุญ

## ๐ฏ ุงููุดููุฉ ุงูุฃุณุงุณูุฉ:

ุนูุฏ ุงูุถุบุท ุนูู "ุฅุฏุงุฑุฉ ุงููุฎุฒูู" ูุชุนุฏูู ุงููููุฉุ ูุงู ูุธูุฑ ุฎุทุฃ:
```
โ ูุดู ูู ุชุญุฏูุซ ุงููุฎุฒูู
ูุง ููุฌุฏ ูุฎุฒูู ููุฐุง ุงูุตูู ูู ูุฐู ุงูุดุฑูุฉ
```

ุฑุบู ุฃู ุงูุตูู ููุฌูุฏ ููุฏูู ูุฎุฒูู!

## ๐ ุงูุณุจุจ ุงูุฌุฐุฑู:

### 1. ูุดููุฉ `companyId` hardcoded:
```typescript
// โ ูู Frontend ูุงู:
await updateStock({
  companyId: 1,  // hardcoded!
  productId: selectedProduct.id,
  quantity: boxes
});
```

### 2. ูุดููุฉ ุงุณุชุฎุฏุงู `update` ุจุฏูุงู ูู `upsert`:
```typescript
// โ ูู Backend ูุงู:
const existingStock = await this.prisma.stock.findUnique({...});
if (!existingStock) {
  throw new Error('ูุง ููุฌุฏ ูุฎุฒูู ููุฐุง ุงูุตูู ูู ูุฐู ุงูุดุฑูุฉ');
}
await this.prisma.stock.update({...}); // ููุดู ุฅุฐุง ูู ูุฌุฏ ุงูุณุทุฑ
```

### 3. ูุดููุฉ `console.error` ูู ุงููุชุตูุญ:
- ูุงู ูุธูุฑ console.error ูู ุงููุชุตูุญ ูููุณุชุฎุฏู
- ูุฐุง ุบูุฑ ููุจูู ูู production

---

## โ ุงูุญู ุงูููุงุฆู ุงููุทุจู:

### 1. ูู `/client/src/app/products/page.tsx`:

**ุฅุตูุงุญ `companyId`**:
```typescript
// โ ุงูุขู ุตุญูุญ:
const handleUpdateStock = async (boxes: number) => {
  if (!selectedProduct || !currentUser?.companyId) return;
  
  try {
    await updateStock({
      companyId: currentUser.companyId,  // โ ูู ุงููุณุชุฎุฏู ุงูุญุงูู
      productId: selectedProduct.id,
      quantity: boxes
    }).unwrap();
    notifications.products.stockUpdateSuccess(selectedProduct.name, boxes);
    setIsStockModalOpen(false);
    setSelectedProduct(null);
  } catch (error: any) {
    notifications.products.stockUpdateError(error?.data?.message);
    // โ ูุง console.error
  }
};
```

### 2. ูู `/server/src/services/ProductService.ts`:

**ุงุณุชุฎุฏุงู `upsert` ูุน ุญูุงูุฉ**:
```typescript
// โ ุงูุญู ุงูุตุญูุญ:
async updateStock(data: UpdateStockDto): Promise<void> {
  // 1. ุงูุชุญูู ูู ูุฌูุฏ ุงูุตูู
  const product = await this.prisma.product.findUnique({
    where: { id: data.productId },
    include: {
      saleLines: { select: { id: true }, take: 1 },
      purchaseLines: { select: { id: true }, take: 1 },
    }
  });

  if (!product) {
    throw new Error('ุงูุตูู ุบูุฑ ููุฌูุฏ');
  }

  // 2. ุงูุชุญูู ูู ุงุณุชุฎุฏุงู ุงูุตูู ูู ููุงุชูุฑ (ุญูุงูุฉ)
  if (product.saleLines.length > 0 || product.purchaseLines.length > 0) {
    throw new Error('ูุง ูููู ุชุนุฏูู ูุฎุฒูู ุตูู ูุณุชุฎุฏู ูู ููุงุชูุฑ ูุจูุนุงุช ุฃู ูุดุชุฑูุงุช');
  }

  // 3. ุงุณุชุฎุฏุงู upsert: ุชุญุฏูุซ ุฅุฐุง ููุฌูุฏุ ุฅูุดุงุก ุฅุฐุง ุบูุฑ ููุฌูุฏ
  await this.prisma.stock.upsert({
    where: {
      companyId_productId: {
        companyId: data.companyId,
        productId: data.productId,
      }
    },
    update: {
      boxes: data.quantity
    },
    create: {
      companyId: data.companyId,
      productId: data.productId,
      boxes: data.quantity,
    }
  });
}
```

### 3. ูู `/client/src/state/apiUtils.ts`:

**ุฅุฒุงูุฉ console.error**:
```typescript
// โ ุชู ุชุนุทูู logging:
// ุชู ุชุนุทูู logging ููุฃุฎุทุงุก - ูุชู ุนุฑุถูุง ูู notifications ููุท
```

---

## ๐ ุงููุฑู ุจูู ุงูุญููู:

| ุงูุญู | `update` | `upsert` |
|------|----------|----------|
| **ุงูุณุทุฑ ููุฌูุฏ** | ูุญุฏุซู โ | ูุญุฏุซู โ |
| **ุงูุณุทุฑ ุบูุฑ ููุฌูุฏ** | ูุฑูู ุฎุทุฃ โ | ููุดุฆู โ |
| **ุงูุงุณุชุฎุฏุงู** | Update ููุท | Create OR Update |
| **ุงููุฑููุฉ** | ููููุฉ | ุนุงููุฉ |

---

## ๐ฏ ููุงุฐุง `upsert` ูู ุงูุญู ุงูุตุญูุญุ

### ุงูุณููุงุฑูููุงุช:

#### โ ุณููุงุฑูู 1: ุชุญุฏูุซ ูุฎุฒูู ููุฌูุฏ
```
1. ุงูุตูู ูู ุณุทุฑ ูู stock: (companyId: 2, productId: 123, boxes: 200)
2. ุงููุณุชุฎุฏู ูุบูุฑ ุงููููุฉ ุฅูู 300
3. upsert ูุฌุฏ ุงูุณุทุฑ ููุญุฏุซู: (companyId: 2, productId: 123, boxes: 300)
4. โ ุงููุชูุฌุฉ: ุชุญุฏูุซ ูุงุฌุญ
```

#### โ ุณููุงุฑูู 2: ุฅูุดุงุก ูุฎุฒูู ุฌุฏูุฏ
```
1. ุตูู ุฌุฏูุฏ ููุณ ูู ุณุทุฑ ูู stock
2. ุงููุณุชุฎุฏู ูุถุน ุงููููุฉ ุงูุฃููู: 100
3. upsert ูุง ูุฌุฏ ุงูุณุทุฑ ูููุดุฆู: (companyId: 2, productId: 124, boxes: 100)
4. โ ุงููุชูุฌุฉ: ุฅูุดุงุก ูุงุฌุญ
```

#### โ ุณููุงุฑูู 3: ูุญุงููุฉ ุชุนุฏูู ุตูู ูุณุชุฎุฏู
```
1. ุงูุตูู ูุณุชุฎุฏู ูู ูุงุชูุฑุฉ ูุจูุนุงุช
2. ุงููุณุชุฎุฏู ูุญุงูู ุชุนุฏูู ูุฎุฒููู
3. ุงูุชุญูู ูู ุงูุญูุงูุฉ ูุฑูุถ ุงูุนูููุฉ
4. โ ุฑุณุงูุฉ: "ูุง ูููู ุชุนุฏูู ูุฎุฒูู ุตูู ูุณุชุฎุฏู ูู ููุงุชูุฑ"
```

---

## ๐ก๏ธ ุงูุญูุงูุฉ ุงููุทุจูุฉ:

### 1. ุญูุงูุฉ ุงูุจูุงูุงุช:
- โ ููุน ุชุนุฏูู ูุฎุฒูู ุงูุฃุตูุงู ุงููุณุชุฎุฏูุฉ ูู ููุงุชูุฑ
- โ ุงูุชุญูู ูู ูุฌูุฏ ุงูุตูู ูุจู ุงูุชุนุฏูู
- โ ุงุณุชุฎุฏุงู `companyId` ุงูุตุญูุญ ูู ุงููุณุชุฎุฏู

### 2. ุญูุงูุฉ UX:
- โ ูุง console.error ูู ุงููุชุตูุญ
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ูู notifications
- โ ุชุญุฏูุซ ุชููุงุฆู ูููุงุฌูุฉ ุจุนุฏ ุงููุฌุงุญ

### 3. ุญูุงูุฉ ุงูุฃุฏุงุก:
- โ ุงุณุชุนูุงูุงุช ูุญุณููุฉ ูุน `select` ู `take`
- โ ุนุฏู ุชูุฑุงุฑ ุงูุณุทูุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ RTK Query cache invalidation

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ:

1. โ `/client/src/app/products/page.tsx`
   - ุฅุตูุงุญ `companyId` hardcoded
   - ุฅุฒุงูุฉ console.error

2. โ `/server/src/services/ProductService.ts`
   - ุงุณุชุฎุฏุงู `upsert` ุจุฏูุงู ูู `update`
   - ุฅุถุงูุฉ ุญูุงูุฉ ููุฃุตูุงู ุงููุณุชุฎุฏูุฉ
   - ุฅุฒุงูุฉ console.log

3. โ `/client/src/state/apiUtils.ts`
   - ุฅุฒุงูุฉ console.error ููุฃุฎุทุงุก 500

---

## ๐งช ุงูุงุฎุชุจุงุฑ:

### ุงุฎุชุจุงุฑ 1: ุชุญุฏูุซ ูุฎุฒูู ููุฌูุฏ
```
1. ุงูุชุญ ุตูุญุฉ ุงูุฃุตูุงู
2. ุงุฎุชุฑ ุตูู ูู ูุฎุฒูู (ูุซู: ููุณ ููุฑุช ุงุจูุถ - 200 ููุณ)
3. ุงุถุบุท "ุฅุฏุงุฑุฉ ุงููุฎุฒูู"
4. ุบููุฑ ุงููููุฉ ูู 200 ุฅูู 250
5. ุงุญูุธ

โ ุงููุชูุฌุฉ ุงููุชููุนุฉ:
- ูุชู ุชุญุฏูุซ ููุณ ุงูุณุทุฑ ูู stock
- ุงููููุฉ ุชุตุจุญ 250
- ุฑุณุงูุฉ: "ุชู ุชุญุฏูุซ ุงููุฎุฒูู ุจูุฌุงุญ"
- ูุง console.error ูู ุงููุชุตูุญ
```

### ุงุฎุชุจุงุฑ 2: ุฅูุดุงุก ูุฎุฒูู ุฌุฏูุฏ
```
1. ุฃูุดุฆ ุตูู ุฌุฏูุฏ
2. ุงุถุบุท "ุฅุฏุงุฑุฉ ุงููุฎุฒูู"
3. ุฃุฏุฎู ุงููููุฉ ุงูุฃููู: 100

โ ุงููุชูุฌุฉ ุงููุชููุนุฉ:
- ูุชู ุฅูุดุงุก ุณุทุฑ ุฌุฏูุฏ ูู stock
- ุงููููุฉ ุชุตุจุญ 100
- ุฑุณุงูุฉ: "ุชู ุชุญุฏูุซ ุงููุฎุฒูู ุจูุฌุงุญ"
```

### ุงุฎุชุจุงุฑ 3: ูุญุงููุฉ ุชุนุฏูู ุตูู ูุณุชุฎุฏู
```
1. ุงุฎุชุฑ ุตูู ูุณุชุฎุฏู ูู ูุงุชูุฑุฉ
2. ุญุงูู ุชุนุฏูู ูุฎุฒููู

โ ุงููุชูุฌุฉ ุงููุชููุนุฉ:
- ูุชู ุฑูุถ ุงูุนูููุฉ
- ุฑุณุงูุฉ: "ูุง ูููู ุชุนุฏูู ูุฎุฒูู ุตูู ูุณุชุฎุฏู ูู ููุงุชูุฑ"
- Status: 400
```

---

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:

| | ูุจู | ุจุนุฏ |
|---|-----|-----|
| **companyId** | hardcoded (1) โ | ูู ุงููุณุชุฎุฏู โ |
| **ุชุญุฏูุซ ุงููุฎุฒูู** | ููุดู ุฃุญูุงูุงู โ | ูุนูู ุฏุงุฆูุงู โ |
| **ุฅูุดุงุก ูุฎุฒูู ุฌุฏูุฏ** | ูุง ูุนูู โ | ูุนูู โ |
| **console.error** | ูุธูุฑ โ | ูุง ูุธูุฑ โ |
| **ุญูุงูุฉ ุงูุจูุงูุงุช** | ุถุนููุฉ | ูููุฉ โ |
| **ุฑุณุงุฆู ุงูุฎุทุฃ** | ุบูุฑ ูุงุถุญุฉ | ูุงุถุญุฉ โ |

---

## ๐ก ุงูุฏุฑูุณ ุงููุณุชูุงุฏุฉ:

1. **`upsert` vs `update`**: 
   - ุงุณุชุฎุฏู `upsert` ุนูุฏูุง ุชุฑูุฏ ูุฑููุฉ (Create OR Update)
   - ุงุณุชุฎุฏู `update` ุนูุฏูุง ุชุฑูุฏ ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูุณุทุฑ

2. **ูุง hardcoded values**: 
   - ุฏุงุฆูุงู ุงุณุชุฎุฏู ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุญุงูู
   - ุชุญูู ูู ูุฌูุฏ ุงูุจูุงูุงุช ูุจู ุงูุงุณุชุฎุฏุงู

3. **ูุง console.error ูู production**: 
   - ุงุณุชุฎุฏู notifications ูููุณุชุฎุฏู
   - console.error ููุท ูููุทูุฑูู ูู development

4. **ุญูุงูุฉ ุงูุจูุงูุงุช**: 
   - ุชุญูู ูู ููุงุนุฏ ุงูุนูู ูุจู ุงูุชุนุฏูู
   - ููุน ุงูุนูููุงุช ุงูุฎุทุฑุฉ ุนูู ุงูุจูุงูุงุช ุงููุณุชุฎุฏูุฉ

5. **UX ุฃููุงู**: 
   - ุฑุณุงุฆู ูุงุถุญุฉ ูููุณุชุฎุฏู
   - ูุง ุฃุฎุทุงุก ุชูููุฉ ูู ุงููุงุฌูุฉ
   - ุชุญุฏูุซ ุชููุงุฆู ุจุนุฏ ุงููุฌุงุญ

---

## โ ุงูุฎูุงุตุฉ:

ุชู ุญู ุงููุดููุฉ ุจุดูู ูุงูู! ุงูุขู:
- โ **ูุนูู ุชุญุฏูุซ ุงููุฎุฒูู ุจูุฌุงุญ**
- โ **ูุนูู ุฅูุดุงุก ูุฎุฒูู ุฌุฏูุฏ**
- โ **ูุง console.error ูู ุงููุชุตูุญ**
- โ **ุญูุงูุฉ ูููุฉ ููุจูุงูุงุช**
- โ **ุฑุณุงุฆู ูุงุถุญุฉ ูููุณุชุฎุฏู**
- โ **ุงุณุชุฎุฏุงู `companyId` ุงูุตุญูุญ**

**ุงูุญู ุงูููุงุฆู: `upsert` ูุน ุญูุงูุฉ + ุฅุฒุงูุฉ console errors = ูุธุงู ูุซุงูู!** ๐
