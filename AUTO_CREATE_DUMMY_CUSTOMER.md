# إنشاء عميل وهمي تلقائياً عند إضافة شركة فرعية

## 🎯 الفكرة:

بدلاً من إنشاء العميل الوهمي عند كل عملية بيع معقدة، يتم إنشاؤه **تلقائياً** عند إضافة شركة فرعية جديدة.

---

## ✅ المميزات:

### 1. **إنشاء تلقائي**:
- عند إضافة شركة فرعية جديدة
- يتم إنشاء عميل وهمي بنفس الاسم
- بدون تدخل يدوي

### 2. **معلومات واضحة**:
```typescript
{
  name: "شركة الإمارات",           // نفس اسم الشركة
  phone: "BRANCH-2",                // معرف فريد
  note: "عميل وهمي يمثل الشركة الفرعية: شركة الإمارات"
}
```

### 3. **لا تكرار**:
- معرف فريد: `BRANCH-{companyId}`
- لا يمكن إنشاء عميل وهمي مكرر لنفس الشركة

### 4. **Fallback آمن**:
- إذا فشل إنشاء العميل الوهمي، لا تفشل عملية إنشاء الشركة
- المبيعات المعقدة تتحقق وتنشئ العميل إذا لم يكن موجوداً

---

## 🔧 الكود المطبق:

### في CompanyService.createCompany():

```typescript
// بعد إنشاء الشركة بنجاح
console.log('✅ Company created successfully:', result);

// إذا كانت شركة فرعية، أنشئ عميل وهمي يمثلها
if (!data.isParent && result.id) {
  try {
    const dummyCustomer = await this.prisma.customer.create({
      data: {
        name: result.name,
        phone: `BRANCH-${result.id}`,
        note: `عميل وهمي يمثل الشركة الفرعية: ${result.name}`
      }
    });
    console.log('✅ Dummy customer created for branch company:', dummyCustomer);
  } catch (customerError) {
    console.error('⚠️ Failed to create dummy customer (non-critical):', customerError);
    // لا نرمي خطأ هنا لأن الشركة تم إنشاؤها بنجاح
  }
}

return result;
```

---

## 📊 مثال عملي:

### السيناريو:
```
إضافة شركة فرعية جديدة:
- الاسم: شركة الإمارات
- الكود: EMR
- الشركة الأم: شركة التقازي (ID: 1)
```

### النتيجة:
```
1. إنشاء الشركة:
   ✅ Company created:
   - ID: 2
   - Name: شركة الإمارات
   - Code: EMR
   - isParent: false
   - parentId: 1

2. إنشاء العميل الوهمي تلقائياً:
   ✅ Dummy customer created:
   - ID: 10
   - Name: شركة الإمارات
   - Phone: BRANCH-2
   - Note: عميل وهمي يمثل الشركة الفرعية: شركة الإمارات
```

---

## 🔄 التكامل مع المبيعات المعقدة:

### الكود الحالي (يعمل كـ Fallback):
```typescript
// البحث عن عميل وهمي
let branchAsCustomer = await tx.customer.findFirst({
  where: {
    phone: `BRANCH-${data.branchCompanyId}`
  }
});

// إذا لم يوجد، أنشئه (fallback)
if (!branchAsCustomer) {
  branchAsCustomer = await tx.customer.create({
    data: {
      name: branchCompany.name,
      phone: `BRANCH-${data.branchCompanyId}`,
      note: `عميل وهمي يمثل الشركة الفرعية: ${branchCompany.name}`
    }
  });
}
```

### الفائدة:
- **الحالة العادية**: العميل الوهمي موجود (تم إنشاؤه مع الشركة)
- **حالة الطوارئ**: إذا لم يكن موجود، يتم إنشاؤه (fallback)
- **النتيجة**: النظام يعمل في جميع الحالات

---

## 🧪 الاختبار:

### 1. إضافة شركة فرعية جديدة:
```
POST /api/company/companies
{
  "name": "شركة الإمارات",
  "code": "EMR",
  "isParent": false,
  "parentId": 1
}
```

### 2. التحقق من إنشاء العميل الوهمي:
```sql
SELECT * FROM Customer 
WHERE phone = 'BRANCH-2';

-- النتيجة المتوقعة:
-- id: 10
-- name: شركة الإمارات
-- phone: BRANCH-2
-- note: عميل وهمي يمثل الشركة الفرعية: شركة الإمارات
```

### 3. إنشاء عملية بيع معقدة:
```
- الشركة الأم: التقازي (ID: 1)
- الشركة الفرعية: الإمارات (ID: 2)
- العميل: محمد أحمد
```

### 4. التحقق من الفاتورة:
```sql
SELECT * FROM Sale 
WHERE companyId = 1 
AND customerId = 10;

-- يجب أن تظهر فاتورة من التقازي للإمارات (كعميل)
```

---

## 💡 الفوائد:

### 1. **تنظيم أفضل**:
- العميل الوهمي يُنشأ مرة واحدة فقط
- لا حاجة للتحقق في كل عملية بيع

### 2. **أداء محسن**:
- تقليل عمليات البحث والإنشاء
- العميل الوهمي جاهز دائماً

### 3. **وضوح أكبر**:
- في جدول العملاء، يمكن رؤية جميع الشركات الفرعية كعملاء
- الملاحظة توضح أنه عميل وهمي

### 4. **سهولة التتبع**:
- يمكن البحث عن جميع العملاء الوهميين: `phone LIKE 'BRANCH-%'`
- يمكن معرفة أي شركة من المعرف: `BRANCH-2` = شركة ID 2

---

## 🔍 حالات خاصة:

### 1. إذا فشل إنشاء العميل الوهمي:
```typescript
catch (customerError) {
  console.error('⚠️ Failed to create dummy customer (non-critical):', customerError);
  // لا نرمي خطأ - الشركة تم إنشاؤها بنجاح
}
```
- الشركة تُنشأ بنجاح
- يتم تسجيل الخطأ في الـ logs
- المبيعات المعقدة ستنشئ العميل عند الحاجة (fallback)

### 2. إذا كانت الشركة أم:
```typescript
if (!data.isParent && result.id) {
  // فقط للشركات الفرعية
}
```
- لا يتم إنشاء عميل وهمي للشركات الأم
- الشركات الأم لا تحتاج عملاء وهميين

### 3. إذا كان العميل الوهمي موجود مسبقاً:
- سيفشل الإنشاء بسبب unique constraint على `phone`
- يتم التعامل معه في catch block
- لا يؤثر على إنشاء الشركة

---

## 📁 الملف المحدث:
- ✅ `/server/src/services/CompanyService.ts`
  - دالة `createCompany()`

---

## ✨ النتيجة النهائية:

الآن عند إضافة شركة فرعية:
- ✅ **الشركة تُنشأ بنجاح**
- ✅ **عميل وهمي يُنشأ تلقائياً**
- ✅ **معلومات واضحة** (الاسم، المعرف، الملاحظة)
- ✅ **جاهز للمبيعات المعقدة** فوراً
- ✅ **يظهر في المبيعات الآجلة** تلقائياً

**النظام الآن أكثر تنظيماً وكفاءة!** 🎉
