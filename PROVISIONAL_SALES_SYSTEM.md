# نظام الفواتير المبدئية - Provisional Sales System

## نظرة عامة
تم إنشاء نظام شامل للفواتير المبدئية يتيح إنشاء فواتير مبيعات مبدئية دون التأثير على المخزون أو المحاسبة، مع إمكانية ترحيلها لاحقاً إلى فواتير مبيعات عادية.

## الميزات الرئيسية

### 1. إدارة الفواتير المبدئية
- **إنشاء فاتورة مبدئية**: إنشاء فاتورة جديدة مع منتجات وأسعار
- **تعديل الفاتورة**: تعديل المنتجات والأسعار والعميل
- **إدارة الحالات**: مسودة، معلقة، معتمدة، مرحلة، ملغية
- **البحث والفلترة**: بحث متقدم بالعميل والحالة والتاريخ

### 2. ترحيل الفواتير
- **ترحيل آمن**: تحويل الفاتورة المبدئية إلى فاتورة مبيعات عادية
- **تحديث المخزون**: خصم الكميات من المخزون عند الترحيل
- **ربط الفواتير**: ربط الفاتورة المبدئية بالفاتورة المرحلة

### 3. التحكم في الصلاحيات
- **حالات متدرجة**: مسار عمل محدد للموافقة والترحيل
- **منع التعديل**: منع تعديل الفواتير المرحلة
- **تتبع التغييرات**: تسجيل تواريخ الإنشاء والتحديث والترحيل

## هيكل قاعدة البيانات

### جدول ProvisionalSale
```sql
- id: معرف الفاتورة المبدئية
- companyId: معرف الشركة البائعة
- customerId: معرف العميل (اختياري)
- invoiceNumber: رقم الفاتورة (اختياري)
- total: إجمالي الفاتورة
- status: حالة الفاتورة (DRAFT, PENDING, APPROVED, CONVERTED, CANCELLED)
- isConverted: هل تم ترحيلها؟
- convertedSaleId: معرف الفاتورة المرحلة إليها
- notes: ملاحظات
- createdAt, updatedAt, convertedAt: تواريخ مهمة
```

### جدول ProvisionalSaleLine
```sql
- id: معرف السطر
- provisionalSaleId: معرف الفاتورة المبدئية
- productId: معرف المنتج
- qty: الكمية
- unitPrice: سعر الوحدة
- subTotal: المجموع الفرعي
```

## API Endpoints

### الفواتير المبدئية
```
POST   /api/provisional-sales              # إنشاء فاتورة مبدئية
GET    /api/provisional-sales              # قائمة الفواتير مع البحث
GET    /api/provisional-sales/:id          # فاتورة واحدة
PUT    /api/provisional-sales/:id          # تحديث فاتورة
DELETE /api/provisional-sales/:id          # حذف فاتورة
```

### العمليات الخاصة
```
PATCH  /api/provisional-sales/:id/status   # تغيير الحالة
POST   /api/provisional-sales/:id/convert  # ترحيل إلى فاتورة عادية
```

## أمثلة الاستخدام

### 1. إنشاء فاتورة مبدئية
```json
POST /api/provisional-sales
{
  "companyId": 1,
  "customerId": 5,
  "invoiceNumber": "PROV-2024-001",
  "status": "DRAFT",
  "notes": "فاتورة مبدئية للعميل الجديد",
  "lines": [
    {
      "productId": 10,
      "qty": 5,
      "unitPrice": 100.00
    },
    {
      "productId": 15,
      "qty": 2,
      "unitPrice": 250.00
    }
  ]
}
```

### 2. البحث في الفواتير
```
GET /api/provisional-sales?companyId=1&status=APPROVED&search=عميل&page=1&limit=10
```

### 3. ترحيل فاتورة مبدئية
```json
POST /api/provisional-sales/123/convert
{
  "saleType": "CREDIT",
  "paymentMethod": "CASH"
}
```

### 4. تغيير حالة الفاتورة
```json
PATCH /api/provisional-sales/123/status
{
  "status": "APPROVED"
}
```

## مسار العمل المقترح

### 1. إنشاء الفاتورة
- المستخدم ينشئ فاتورة مبدئية بحالة "DRAFT"
- يضيف المنتجات والأسعار
- يحفظ الفاتورة للمراجعة لاحقاً

### 2. المراجعة والاعتماد
- تغيير الحالة إلى "PENDING" للمراجعة
- المدير يراجع ويعتمد بتغيير الحالة إلى "APPROVED"
- أو يرفض بتغيير الحالة إلى "CANCELLED"

### 3. الترحيل
- عند الاعتماد، يمكن ترحيل الفاتورة إلى فاتورة مبيعات عادية
- يتم خصم الكميات من المخزون
- تصبح الحالة "CONVERTED" ولا يمكن تعديلها

## الفوائد

### 1. للمبيعات
- **مرونة في التسعير**: تجربة أسعار مختلفة دون التأثير على النظام
- **عروض أسعار**: استخدامها كعروض أسعار للعملاء
- **تخطيط المبيعات**: تخطيط المبيعات المستقبلية

### 2. للإدارة
- **تحكم أفضل**: مراجعة واعتماد الفواتير قبل التنفيذ
- **تقارير دقيقة**: فصل الفواتير المبدئية عن الفعلية
- **تتبع الأداء**: تتبع معدلات تحويل الفواتير المبدئية

### 3. للمخزون
- **حماية المخزون**: عدم التأثير على المخزون حتى الترحيل
- **تخطيط أفضل**: معرفة الطلب المتوقع مسبقاً
- **تجنب الأخطاء**: مراجعة الكميات قبل الخصم

## ملاحظات مهمة

### الأمان
- التحقق من صحة البيانات في جميع المراحل
- منع تعديل الفواتير المرحلة
- تسجيل جميع العمليات للمراجعة

### الأداء
- فهرسة الجداول للبحث السريع
- تحسين استعلامات قاعدة البيانات
- تخزين مؤقت للبيانات المتكررة

### التطوير المستقبلي
- إضافة تقارير خاصة بالفواتير المبدئية
- تكامل مع نظام الإشعارات
- إضافة صلاحيات متقدمة للمستخدمين

## الملفات المنشأة

### Backend Files
```
/server/prisma/schema.prisma                    # تحديث قاعدة البيانات
/server/src/dto/provisionalSalesDto.ts         # كائنات نقل البيانات
/server/src/services/ProvisionalSalesService.ts # منطق العمل
/server/src/controllers/ProvisionalSalesController.ts # التحكم في API
/server/src/routes/provisionalSalesRoutes.ts   # مسارات API
/server/src/index.ts                           # تحديث الخادم الرئيسي
```

### Database Changes
- إضافة جدول `ProvisionalSale`
- إضافة جدول `ProvisionalSaleLine`
- إضافة enum `ProvisionalSaleStatus`
- إضافة العلاقات المطلوبة

## التشغيل والاختبار

### 1. تطبيق التغييرات
```bash
cd server
npx prisma migrate dev --name add-provisional-sales
npx prisma generate
```

### 2. تشغيل الخادم
```bash
npm run dev
```

### 3. اختبار API
استخدم Postman أو أي أداة مشابهة لاختبار endpoints المختلفة

---

تم إنشاء نظام شامل ومتكامل للفواتير المبدئية يوفر مرونة كبيرة في إدارة المبيعات مع الحفاظ على سلامة البيانات والمخزون.
