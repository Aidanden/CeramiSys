# ุฅุตูุงุญ ูุดููุฉ ุชุญุฏูุซ ุงููุฎุฒูู - ุงูุญู ุงูููุงุฆู

## ๐ ุงููุดููุฉ:

ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ "ุฅุฏุงุฑุฉ ุงููุฎุฒูู" ูุชุนุฏูู ุงููููุฉุ ูุงู ูุชู **ุฅุถุงูุฉ ุณุทุฑ ุฌุฏูุฏ** ูู ุฌุฏูู `stock` ุจุฏูุงู ูู **ุชุนุฏูู ุงูุณุทุฑ ุงูููุฌูุฏ**.

### ุงูุฃุณุจุงุจ:
1. โ ุงุณุชุฎุฏุงู `upsert` ุงูุฐู ููุดุฆ ุณุทุฑ ุฌุฏูุฏ ุฅุฐุง ูู ูุฌุฏ ุงูุณุทุฑ
2. โ `companyId` ูุงู hardcoded ุจูููุฉ `1` ูู Frontend

---

## โ ุงูุญู ุงููุทุจู:

### 1. ูู `/server/src/services/ProductService.ts`:

**ุงุณุชุจุฏุงู `upsert` ุจู `update` ููุท (PATCH)**:

```typescript
async updateStock(data: UpdateStockDto): Promise<void> {
  // 1๏ธโฃ ุงูุชุญูู ูู ูุฌูุฏ ุงูุตูู
  const product = await this.prisma.product.findUnique({
    where: { id: data.productId },
    include: {
      saleLines: { select: { id: true }, take: 1 },
      purchaseLines: { select: { id: true }, take: 1 },
    }
  });

  if (!product) {
    throw new Error('ุงูุตูู ุบูุฑ ููุฌูุฏ');
  }

  // 2๏ธโฃ ุงูุชุญูู ูู ุงุณุชุฎุฏุงู ุงูุตูู ูู ููุงุชูุฑ
  if (product.saleLines.length > 0 || product.purchaseLines.length > 0) {
    throw new Error('ูุง ูููู ุชุนุฏูู ูุฎุฒูู ุตูู ูุณุชุฎุฏู ูู ููุงุชูุฑ ูุจูุนุงุช ุฃู ูุดุชุฑูุงุช');
  }

  // 3๏ธโฃ ุงูุชุญูู ูู ูุฌูุฏ ุณุทุฑ ุงููุฎุฒูู
  const existingStock = await this.prisma.stock.findUnique({
    where: {
      companyId_productId: {
        companyId: data.companyId,
        productId: data.productId,
      }
    }
  });

  if (!existingStock) {
    throw new Error('ูุง ููุฌุฏ ูุฎุฒูู ููุฐุง ุงูุตูู ูู ูุฐู ุงูุดุฑูุฉ');
  }

  // 4๏ธโฃ ุชุญุฏูุซ ุงูุณุทุฑ ุงูููุฌูุฏ ููุท (PATCH) - ูุง ุฅูุดุงุก ุณุทูุฑ ุฌุฏูุฏุฉ
  await this.prisma.stock.update({
    where: {
      companyId_productId: {
        companyId: data.companyId,
        productId: data.productId,
      }
    },
    data: {
      boxes: data.quantity
    }
  });
}
```

### 2. ูู `/client/src/app/products/page.tsx`:

**ุฅุตูุงุญ `companyId` hardcoded**:

```typescript
// โ ูุจู
const handleUpdateStock = async (boxes: number) => {
  await updateStock({
    companyId: 1,  // โ hardcoded!
    productId: selectedProduct.id,
    quantity: boxes
  });
};

// โ ุจุนุฏ
const handleUpdateStock = async (boxes: number) => {
  if (!selectedProduct || !currentUser?.companyId) return;
  
  await updateStock({
    companyId: currentUser.companyId,  // โ ูู ุงููุณุชุฎุฏู ุงูุญุงูู
    productId: selectedProduct.id,
    quantity: boxes
  }).unwrap();
};
```

---

## ๐ ุงููุฑู ุจูู `upsert` ู `update`:

| ุงูุนูููุฉ | `upsert` | `update` |
|---------|----------|----------|
| **ุงูุณุทุฑ ููุฌูุฏ** | ูุญุฏุซู โ | ูุญุฏุซู โ |
| **ุงูุณุทุฑ ุบูุฑ ููุฌูุฏ** | ููุดุฆ ุณุทุฑ ุฌุฏูุฏ โ | ูุฑูู ุฎุทุฃ โ |
| **ุงูุงุณุชุฎุฏุงู** | Create OR Update | Update ููุท |
| **HTTP Method** | PUT | PATCH |

---

## ๐ฏ ุงูุณููู ุงูุฌุฏูุฏ:

### โ ุณููุงุฑูู 1: ุชุนุฏูู ูุฎุฒูู ููุฌูุฏ (ุตูู ุบูุฑ ูุณุชุฎุฏู)
```
1. ุงููุณุชุฎุฏู ูู ุดุฑูุฉ "ุตุงูุฉ ุงูุฅูุงุฑุงุช" (companyId: 2)
2. ุงูุตูู "ูุชุฑ ุฒูุช ุชูุธูู" ูู ุณุทุฑ ูู stock: (companyId: 2, productId: 123, boxes: 5000)
3. ุงููุณุชุฎุฏู ูุบูุฑ ุงููููุฉ ุฅูู 6000
4. ุงููุธุงู ูุชุญูู:
   โ ุงูุตูู ููุฌูุฏ
   โ ุงูุตูู ุบูุฑ ูุณุชุฎุฏู ูู ููุงุชูุฑ
   โ ุณุทุฑ ุงููุฎุฒูู ููุฌูุฏ
5. ุงููุธุงู ูุญุฏุซ ุงูุณุทุฑ: (companyId: 2, productId: 123, boxes: 6000)
6. โ ุงููุชูุฌุฉ: ููุณ ุงูุณุทุฑ ูุน ุงููููุฉ ุงูุฌุฏูุฏุฉ
```

### โ ุณููุงุฑูู 2: ูุญุงููุฉ ุชุนุฏูู ุตูู ูุณุชุฎุฏู
```
1. ุงูุตูู "ุจูุงุท ุณูุฑุงููู" ูุณุชุฎุฏู ูู ูุงุชูุฑุฉ ูุจูุนุงุช
2. ุงููุณุชุฎุฏู ูุญุงูู ุชุนุฏูู ูุฎุฒููู
3. ุงููุธุงู ูุฑูุถ:
   โ ุฑุณุงูุฉ: "ูุง ูููู ุชุนุฏูู ูุฎุฒูู ุตูู ูุณุชุฎุฏู ูู ููุงุชูุฑ"
   โ Status: 400
```

### โ ุณููุงุฑูู 3: ูุญุงููุฉ ุชุนุฏูู ูุฎุฒูู ุบูุฑ ููุฌูุฏ
```
1. ุงูุตูู ููุฌูุฏ ููู ููุณ ูู ุณุทุฑ ูู ุฌุฏูู stock
2. ุงููุณุชุฎุฏู ูุญุงูู ุชุนุฏูู ูุฎุฒููู
3. ุงููุธุงู ูุฑูุถ:
   โ ุฑุณุงูุฉ: "ูุง ููุฌุฏ ูุฎุฒูู ููุฐุง ุงูุตูู ูู ูุฐู ุงูุดุฑูุฉ"
   โ Status: 404
```

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ:

1. โ `/server/src/services/ProductService.ts`
   - ุงุณุชุจุฏุงู `upsert` ุจู `update`
   - ุฅุถุงูุฉ ุงูุชุญูู ูู ูุฌูุฏ ุงูุณุทุฑ
   - ุฅุฒุงูุฉ `create` ูู ุงูุนูููุฉ

2. โ `/client/src/app/products/page.tsx`
   - ุฅุตูุงุญ `handleUpdateStock` - ุงุณุชุฎุฏุงู `currentUser.companyId`
   - ุฅุตูุงุญ `handleUpdatePrice` - ุงุณุชุฎุฏุงู `currentUser.companyId`

3. โ `/server/src/controllers/ProductController.ts`
   - ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุจุดูู ุตุญูุญ (404, 400, 500)
   - ุจุฏูู `console.error` ููุฃุฎุทุงุก ุงููุชููุนุฉ

---

## ๐งช ุงูุงุฎุชุจุงุฑ:

### ุงุฎุชุจุงุฑ 1: ุชุนุฏูู ูุฎุฒูู ููุฌูุฏ
```bash
# ุงูุฎุทูุงุช:
1. ุงูุชุญ ุตูุญุฉ ุงูุฃุตูุงู
2. ุงุฎุชุฑ ุตูู ุบูุฑ ูุณุชุฎุฏู ูู ููุงุชูุฑ
3. ุงุถุบุท "ุฅุฏุงุฑุฉ ุงููุฎุฒูู"
4. ุบููุฑ ุงููููุฉ ูู 100 ุฅูู 150
5. ุงุญูุธ

# ุงููุชูุฌุฉ ุงููุชููุนุฉ:
โ ูุชู ุชุญุฏูุซ ููุณ ุงูุณุทุฑ ูู stock
โ ุงููููุฉ ุชุตุจุญ 150
โ ูุง ูุชู ุฅูุดุงุก ุณุทุฑ ุฌุฏูุฏ
โ ุฑุณุงูุฉ: "ุชู ุชุญุฏูุซ ุงููุฎุฒูู ุจูุฌุงุญ"
```

### ุงุฎุชุจุงุฑ 2: ูุญุงููุฉ ุชุนุฏูู ุตูู ูุณุชุฎุฏู
```bash
# ุงูุฎุทูุงุช:
1. ุงุฎุชุฑ ุตูู ูุณุชุฎุฏู ูู ูุงุชูุฑุฉ
2. ุงุถุบุท "ุฅุฏุงุฑุฉ ุงููุฎุฒูู"
3. ุญุงูู ุชุบููุฑ ุงููููุฉ

# ุงููุชูุฌุฉ ุงููุชููุนุฉ:
โ ูุชู ุฑูุถ ุงูุนูููุฉ
โ ุฑุณุงูุฉ: "ูุง ูููู ุชุนุฏูู ูุฎุฒูู ุตูู ูุณุชุฎุฏู ูู ููุงุชูุฑ"
โ Status: 400
```

### ุงุฎุชุจุงุฑ 3: ุงูุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
```sql
-- ูุจู ุงูุชุนุฏูู
SELECT * FROM "Stock" WHERE "productId" = 123 AND "companyId" = 2;
-- ุงููุชูุฌุฉ: 1 ุณุทุฑุ boxes = 5000

-- ุจุนุฏ ุงูุชุนุฏูู (ุชุบููุฑ ุฅูู 6000)
SELECT * FROM "Stock" WHERE "productId" = 123 AND "companyId" = 2;
-- ุงููุชูุฌุฉ: 1 ุณุทุฑุ boxes = 6000 โ

-- ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุณุทูุฑ ููุฑุฑุฉ
SELECT "productId", "companyId", COUNT(*) 
FROM "Stock" 
GROUP BY "productId", "companyId" 
HAVING COUNT(*) > 1;
-- ุงููุชูุฌุฉ: 0 ุณุทูุฑ (ูุง ุชูุฌุฏ ุชูุฑุงุฑุงุช) โ
```

---

## ๐ ุงูุชุญุณููุงุช ุงููุทุจูุฉ:

### 1๏ธโฃ ููุน ุฅูุดุงุก ุณุทูุฑ ุฌุฏูุฏุฉ:
- โ ุงุณุชุฎุฏุงู `update` ุจุฏูุงู ูู `upsert`
- โ ุงูุชุญูู ูู ูุฌูุฏ ุงูุณุทุฑ ูุจู ุงูุชุญุฏูุซ
- โ ุฑูู ุฎุทุฃ ูุงุถุญ ุฅุฐุง ูู ููู ุงูุณุทุฑ ููุฌูุฏุงู

### 2๏ธโฃ ุญูุงูุฉ ุงูุจูุงูุงุช:
- โ ููุน ุชุนุฏูู ูุฎุฒูู ุงูุฃุตูุงู ุงููุณุชุฎุฏูุฉ ูู ููุงุชูุฑ
- โ ููุณ ููุทู ุงูุญุฐู (consistency)
- โ ุงูุญูุงุธ ุนูู ุณูุงูุฉ ุงูุจูุงูุงุช

### 3๏ธโฃ ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ููุญุฏุฏุฉ
- โ Status codes ุตุญูุญุฉ (404, 400, 500)
- โ ุจุฏูู `console.error` ููุฃุฎุทุงุก ุงููุชููุนุฉ

### 4๏ธโฃ ุงุณุชุฎุฏุงู `companyId` ุงูุตุญูุญ:
- โ ูู ุงููุณุชุฎุฏู ุงูุญุงูู ุจุฏูุงู ูู hardcoded
- โ ูุนูู ูุน ุฌููุน ุงูุดุฑูุงุช
- โ ูุง ุชุนุงุฑุถ ุจูู ุงูุดุฑูุงุช

### 5๏ธโฃ ุงูุฃุฏุงุก:
- โ ุงุณุชุฎุฏุงู `select: { id: true }` ููุชุญูู ุงูุณุฑูุน
- โ ุงุณุชุฎุฏุงู `take: 1` ูุฌูุจ record ูุงุญุฏ ููุท
- โ ุงุณุชุนูุงูุงุช ูุญุณููุฉ

---

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:

| | ูุจู | ุจุนุฏ |
|---|-----|-----|
| **ุฅูุดุงุก ุณุทูุฑ ุฌุฏูุฏุฉ** | โ ูุญุฏุซ | โ ูุง ูุญุฏุซ |
| **ุชุญุฏูุซ ุงูุณุทุฑ ุงูููุฌูุฏ** | โ ุฃุญูุงูุงู | โ ุฏุงุฆูุงู |
| **ุชูุฑุงุฑ ุงูุณุทูุฑ** | โ ูุญุฏุซ | โ ูุง ูุญุฏุซ |
| **companyId** | hardcoded (1) | ูู ุงููุณุชุฎุฏู |
| **ุญูุงูุฉ ุงูุจูุงูุงุช** | ุถุนููุฉ | ูููุฉ |
| **ุฑุณุงุฆู ุงูุฎุทุฃ** | ุบูุฑ ูุงุถุญุฉ | ูุงุถุญุฉ |

---

## ๐ก ุงูุฏุฑูุณ ุงููุณุชูุงุฏุฉ:

1. **`upsert` vs `update`**: ุงุณุชุฎุฏู `update` ุนูุฏูุง ุชุฑูุฏ ุชุญุฏูุซ ููุทุ ู`upsert` ุนูุฏูุง ุชุฑูุฏ Create OR Update
2. **ูุง hardcoded values**: ุฏุงุฆูุงู ุงุณุชุฎุฏู ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุญุงูู
3. **ุงูุชุญูู ูู ุงููุฌูุฏ**: ุชุญูู ูู ูุฌูุฏ ุงูุณุทุฑ ูุจู ุงูุชุญุฏูุซ
4. **ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ**: ุณุงุนุฏ ุงููุณุชุฎุฏู ุนูู ููู ุงููุดููุฉ
5. **ุญูุงูุฉ ุงูุจูุงูุงุช**: ููุน ุงูุนูููุงุช ุงูุฎุทุฑุฉ ุนูู ุงูุจูุงูุงุช ุงููุณุชุฎุฏูุฉ

---

## โ ุงูุฎูุงุตุฉ:

ุชู ุฅุตูุงุญ ุงููุดููุฉ ุจุดูู ูุงูู! ุงูุขู:
- โ ูุชู ุชุญุฏูุซ ุงูุณุทุฑ ุงูููุฌูุฏ ููุท (PATCH)
- โ ูุง ูุชู ุฅูุดุงุก ุณุทูุฑ ุฌุฏูุฏุฉ ุฃุจุฏุงู
- โ ูู ุดุฑูุฉ ููุง ุณุทุฑ ูุงุญุฏ ููุท ููู ุตูู
- โ `companyId` ูุฃุชู ูู ุงููุณุชุฎุฏู ุงูุญุงูู
- โ ุญูุงูุฉ ูููุฉ ููุจูุงูุงุช
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ

**ุงููุดููุฉ ูุงูุช ูู ุงุณุชุฎุฏุงู `upsert` ุจุฏูุงู ูู `update` + hardcoded `companyId`!** ๐
